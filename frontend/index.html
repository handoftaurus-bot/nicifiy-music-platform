<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hotify - Hand Of Taurus - Streaming Radio</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 24px;
      background: #0f1115;
      color: #e7e7e7;
      max-width: 900px;
      margin: 0 auto;
    }
    h1 { margin: 0 0 8px; }
    .sub { color: #9aa4b2; margin-bottom: 18px; }

    .card {
      background: #151922;
      border: 1px solid #232a36;
      border-radius: 12px;
      padding: 16px;
      margin: 12px 0;
    }

    .row {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    button {
      background: #2b90ff;
      border: none;
      color: white;
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .tracks {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
    }

    .track {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #232a36;
      background: #10141c;
    }

    .track:hover { border-color: #2b90ff; }

    .meta {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .title { font-weight: 700; }
    .small { color: #9aa4b2; font-size: 12px; }

    audio { width: 100%; margin-top: 10px; }

    .status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 10px;
      background: #0b1220;
      border: 1px solid #232a36;
      color: #9aa4b2;
      white-space: pre-wrap;
    }

    .error { color: #ff6b6b; }
    .ok { color: #7ee787; }
  </style>
</head>
<body>
  <h1><center>
    <img src="assets/Hotify.png" alt="Hotify" style="height:200px; width:auto;">
  </h1></body></center>
  <div class="sub"></div>

  <div class="card">
    <div class="row">
      <div>
        <div class="title">Now Playing</div>
        <div id="nowPlaying" class="small">Nothing yet</div>
      </div>
      <div>
        <button id="refreshBtn">Refresh Tracks</button>
      </div>
    </div>

    <audio id="player" controls></audio>

    <div id="status" class="status">Status: ready</div>
  </div>

  <div class="card">
    <div class="title">Tracks</div>
    <div id="tracks" class="tracks"></div>
  </div>

  <script>
    const API_BASE = "https://czzz7fhbn6.execute-api.us-east-1.amazonaws.com"; // API Gateway URL

    const player = document.getElementById("player");
    const tracksEl = document.getElementById("tracks");
    const nowPlayingEl = document.getElementById("nowPlaying");
    const statusEl = document.getElementById("status");
    const refreshBtn = document.getElementById("refreshBtn");

    function setStatus(msg, type="") {
      statusEl.textContent = `Status: ${msg}`;
      statusEl.classList.remove("error", "ok");
      if (type) statusEl.classList.add(type);
    }

    async function fetchJson(url) {
      const res = await fetch(url, { cache: "no-store" });
      const text = await res.text();
      let data;
      try { data = JSON.parse(text); } catch { data = { raw: text }; }

      if (!res.ok) {
        const errMsg = data?.error || data?.message || `${res.status} ${res.statusText}`;
        throw new Error(`${errMsg}\nURL: ${url}`);
      }
      return data;
    }

    function renderTracks(tracks) {
      tracksEl.innerHTML = "";

      if (!tracks || tracks.length === 0) {
        tracksEl.innerHTML = `<div class="small">No tracks found. Upload to the raw bucket (Day 9) or add an item to DynamoDB.</div>`;
        return;
      }

      for (const t of tracks) {
        const title = t.title || t.track_id || "Untitled";
        const streamPath = t.stream_path || "(no stream_path)";

        const div = document.createElement("div");
        div.className = "track";

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.innerHTML = `
          <div class="title">${escapeHtml(title)}</div>
          <div class="small">ID: ${escapeHtml(t.track_id || "")}</div>
          <div class="small">Path: ${escapeHtml(streamPath)}</div>
        `;

        const btn = document.createElement("button");
        btn.textContent = "Play";
        btn.onclick = () => playTrack(t);

        div.appendChild(meta);
        div.appendChild(btn);
        tracksEl.appendChild(div);
      }
    }

    async function loadTracks() {
      setStatus("loading tracks...");
      refreshBtn.disabled = true;

      try {
        const data = await fetchJson(`${API_BASE}/tracks`);
        const tracks = data.tracks || [];
        // Optional: sort newest-ish by track_id string, not perfect but helps
        tracks.sort((a, b) => (b.track_id || "").localeCompare(a.track_id || ""));
        renderTracks(tracks);
        setStatus(`loaded ${tracks.length} track(s)`, "ok");
      } catch (err) {
        console.error(err);
        setStatus(err.message, "error");
      } finally {
        refreshBtn.disabled = false;
      }
    }

    async function playTrack(track) {
      const trackId = track.track_id;
      if (!trackId) {
        setStatus("Track missing track_id; can't request stream URL.", "error");
        return;
      }

      setStatus(`fetching stream URL for ${trackId}...`);
      try {
        const data = await fetchJson(`${API_BASE}/tracks/${encodeURIComponent(trackId)}/stream`);
        const url = data.stream_url;

        if (!url) {
          setStatus("No stream_url returned by API.", "error");
          return;
        }

        player.src = url;
        nowPlayingEl.textContent = `${track.title || trackId}`;
        setStatus(`stream URL set. Hit play (or it may auto-play).`, "ok");

        // Auto-play often works after a click (browser allows it since user interacted)
        try { await player.play(); } catch (_) {}
      } catch (err) {
        console.error(err);
        setStatus(err.message, "error");
      }
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    refreshBtn.addEventListener("click", loadTracks);

    // initial load
    loadTracks();
  </script>
</body>
</html>
