<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Current ‚Äî Audio Streaming</title>
  <meta name="color-scheme" content="dark" />
  <style>
    :root{
      --bg:#000;
      --panel:#0b0b0b;
      --panel2:#0f0f0f;
      --text:#e7e7e7;
      --muted:#9aa4b2;
      --border:rgba(255,255,255,.08);
      --card:rgba(255,255,255,.04);
      --card2:rgba(255,255,255,.07);
      --shadow:0 10px 30px rgba(0,0,0,.45);
      --r:14px; --r2:18px; --gap:14px;

      --desktopPlayerH:92px;

      /* Mobile UI heights */
      --mobileNavH:64px;
      --miniPlayerH:64px;

      --safeBottom: env(safe-area-inset-bottom, 0px);
      --safeTop: env(safe-area-inset-top, 0px);

      --accent: rgba(75,163,238,.95);
      --accentSolid:#4ba3ee;
      --accentHover:#61aef0;
      --accentSoft: rgba(75,163,238,.22);
}

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow:hidden;
    }
    a{color:inherit}
    button{font-family:inherit}
    img{user-select:none;-webkit-user-drag:none}

    /* ====== LAYOUT ====== */
    .app{
      height:100vh;
      display:grid;
      grid-template-columns:280px 1fr;
      grid-template-rows:1fr var(--desktopPlayerH);
    }

    /* Desktop sidebar */
    .sidebar{
      grid-row:1;
      grid-column:1;
      padding:16px;
      background:linear-gradient(180deg,#090909,#050505);
      border-right:1px solid var(--border);
      display:flex;
      flex-direction:column;
      gap:14px;
      min-height:0;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:12px;
      user-select:none;
    }
    .brand img{width:34px;height:34px;border-radius:10px;object-fit:cover;}
    .brand .name{font-weight:900;letter-spacing:.2px}
    .brand .tag{font-size:12px;color:var(--muted);margin-top:2px}

    .nav{
      background:rgba(255,255,255,.03);
      border:1px solid var(--border);
      border-radius:var(--r);
      padding:10px;
    }
    .nav a{
      display:flex;align-items:center;gap:10px;
      padding:10px 10px;border-radius:10px;
      text-decoration:none;
      opacity:.86;
      font-weight:800;
      font-size:14px;
      user-select:none;
    }
    .nav a:hover{background:rgba(255,255,255,.06);opacity:1;}
    .nav a.active{background:rgba(255,255,255,.08);opacity:1;}

    .libraryMini{
      flex:1;
      min-height:0;
      overflow:hidden;
      background:rgba(255,255,255,.03);
      border:1px solid var(--border);
      border-radius:var(--r);
      padding:10px;
      display:flex;
      flex-direction:column;
    }
    .libraryMiniHead{
      display:flex;align-items:center;justify-content:space-between;
      padding:8px 8px 10px;
    }
    .libraryMiniHead h3{margin:0;font-size:13px;letter-spacing:.2px;color:#d9d9d9;opacity:.92;}
    .pill{
      font-size:12px;color:var(--muted);
      border:1px solid rgba(255,255,255,.12);
      border-radius:999px;
      padding:6px 10px;
      background:rgba(0,0,0,.25);
    }
    .libraryMiniList{
      overflow:auto;padding:6px;
      display:flex;flex-direction:column;gap:6px;
    }
    .libItem{
      padding:10px;border-radius:12px;
      display:flex;gap:10px;align-items:center;
      cursor:pointer;user-select:none;
    }
    .libItem:hover{background:rgba(255,255,255,.05);}
    .libItem .dot{width:8px;height:8px;border-radius:99px;background:rgba(255,255,255,.18);}
    .libItem .meta{min-width:0;display:flex;flex-direction:column;gap:2px;}
    .libItem .title{font-size:13px;font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .libItem .sub{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

    /* Main */
    .main{
      grid-row:1;
      grid-column:2;
      min-width:0;
      min-height:0;
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(75,163,238,.10), transparent 60%),
        linear-gradient(180deg,#0a0a0a,#000);
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .topbar{
      padding:calc(12px + var(--safeTop)) 18px 12px;
      display:flex;
      gap:12px;
      align-items:center;
      position:sticky;
      top:0;
      z-index:10;
      background:rgba(0,0,0,.55);
      backdrop-filter:blur(10px);
      border-bottom:1px solid var(--border);
    }

    .searchbar{
      flex:1;display:flex;align-items:center;gap:10px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius:999px;
      padding:10px 12px;
      max-width:740px;
      min-width:0;
    }
    .searchbar input{
      width:100%;
      background:transparent;border:none;outline:none;
      color:var(--text);font-size:14px;min-width:0;
    }
    .hint{color:var(--muted);font-size:12px;font-weight:900;}

    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:10px;
      border:none;cursor:pointer;border-radius:999px;
      padding:10px 14px;
      background:rgba(255,255,255,.08);
      color:var(--text);
      font-weight:900;user-select:none;
      border:1px solid rgba(255,255,255,.10);
    }
    .btn:hover{background:rgba(255,255,255,.12);}
    .btn.primary{
      background:rgba(75,163,238,.18);
      border:1px solid rgba(75,163,238,.25);
    }
    .btn.primary:hover{background:rgba(75,163,238,.22);}
    .btn:disabled{opacity:.5;cursor:not-allowed;}

    .content{
      padding:18px;
      overflow:auto;
      min-height:0;
      padding-bottom: calc(var(--desktopPlayerH) + var(--safeBottom) + 14px);
    }

    .sectionTitle{
      display:flex;align-items:end;justify-content:space-between;gap:10px;
      margin:6px 0 14px;
    }
    .sectionTitle h2{margin:0;font-size:22px;letter-spacing:.2px;}

    .grid{display:grid;grid-template-columns:repeat(5,minmax(160px,1fr));gap:var(--gap);}
    @media (max-width:1200px){.grid{grid-template-columns:repeat(4,minmax(160px,1fr));}}
    @media (max-width:980px){.grid{grid-template-columns:repeat(3,minmax(160px,1fr));}}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--r2);
      padding:14px;
      box-shadow:var(--shadow);
      cursor:pointer;
      user-select:none;
      transition:transform .06s ease, background .12s ease;
    }
    .card:hover{background:var(--card2);transform:translateY(-1px);}

    .cover{
      width:100%;
      aspect-ratio:1/1;
      border-radius:14px;
      background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));
      overflow:hidden;
      margin-bottom:12px;
      position:relative;
      display:flex;align-items:center;justify-content:center;
    }
    .cover img{width:100%;height:100%;object-fit:cover;}
    .playFab{
      position:absolute;right:10px;bottom:10px;
      width:42px;height:42px;border-radius:999px;
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.14);
      display:flex;align-items:center;justify-content:center;
      opacity:0;transform:translateY(8px);
      transition:all .12s ease;
      font-weight:900;
    }
    .card:hover .playFab{opacity:1;transform:translateY(0);}
    .tTitle{
      margin:0;font-weight:950;font-size:14px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .tSub{
      margin-top:6px;color:var(--muted);font-size:12px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }

    .table{
      margin-top:14px;
      border:1px solid var(--border);
      border-radius:16px;
      overflow:hidden;
      background:rgba(255,255,255,.03);
    }
    .row{
      display:grid;
      grid-template-columns:44px 1.8fr 1.1fr 86px;
      gap:12px;
      padding:12px 14px;
      align-items:center;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .row.head{
      color:var(--muted);
      font-size:12px;
      font-weight:900;
      background:rgba(0,0,0,.25);
    }
    .row.item{cursor:pointer;}
    .row.item:hover{background:rgba(255,255,255,.05);}
    .row:last-child{border-bottom:none;}
    .num{color:var(--muted);font-weight:950;font-size:12px;}
    .cellTitle{min-width:0;display:flex;flex-direction:column;gap:2px;}
    .cellTitle .t{font-weight:950;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .cellTitle .s{color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .dur{color:var(--muted);font-weight:900;font-size:12px;text-align:right;}

    .pageHero{
      display:flex;gap:18px;align-items:flex-end;margin-bottom:14px;flex-wrap:wrap;
    }
    .bigart{
      width:160px;height:160px;border-radius:18px;overflow:hidden;
      border:1px solid var(--border);background:rgba(255,255,255,.06);
      flex:0 0 auto;
    }
    .bigart img{width:100%;height:100%;object-fit:cover;}
    .kicker{
      color:var(--muted);
      font-size:12px;
      font-weight:950;
      letter-spacing:.12em;
      text-transform:uppercase;
    }
    .bigtitle{
      font-size:44px;font-weight:950;letter-spacing:-.02em;line-height:1.05;
      margin:6px 0 6px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      max-width:min(900px, 100%);
    }
    .bigsub{
      color:var(--muted);font-weight:900;font-size:13px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      max-width:min(900px, 100%);
    }
    .actions{display:flex;gap:10px;align-items:center;margin-top:12px;flex-wrap:wrap;}

    /* ====== DESKTOP PLAYER ====== */
    .player{
      grid-column:1 / 3;
      grid-row:2;
      background:rgba(12,12,12,.92);
      border-top:1px solid var(--border);
      display:grid;
      grid-template-columns:320px 1fr 320px;
      gap:10px;
      padding:12px 14px;
      align-items:center;
      padding-bottom: calc(12px + var(--safeBottom));
    }
    .now{display:flex;gap:12px;align-items:center;min-width:0;}
    .now .art{
      width:54px;height:54px;border-radius:12px;overflow:hidden;
      background:rgba(255,255,255,.06);
      border:1px solid var(--border);
      flex:0 0 auto;
    }
    .now .art img{width:100%;height:100%;object-fit:cover;}
    .now .meta{min-width:0;}
    .now .meta .t{font-weight:950;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .now .meta .s{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:3px;}

    .controls{display:flex;flex-direction:column;gap:10px;align-items:center;justify-content:center;min-width:0;}
    .ctrlRow{display:flex;align-items:center;justify-content:center;gap:10px;}
    .iconBtn {
      position: relative;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #b3b3b3;
      transition: color .15s ease, transform .15s ease;
    }

    .iconBtn svg {
      width: 22px;
      height: 22px;
      fill: currentColor;
    }

    .iconBtn:hover {
      color: #ffffff;
      transform: scale(1.06);
    }
    .iconBtn.active {
      color: var(--accentSolid);
    }


    .playBtn {
      background: var(--accentSolid);
      color: #000;
    }

    .playBtn:hover {
      background: var(--accentHover);
      transform: scale(1.1);
    }

    .timeline{
      width:min(720px,100%);
      display:flex;align-items:center;gap:10px;
      color:var(--muted);font-size:12px;font-weight:950;
    }
    input[type="range"]{
      -webkit-appearance:none;
      appearance:none;
      height:4px;border-radius:999px;
      background:rgba(255,255,255,.16);
      outline:none;width:100%;
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none;
      appearance:none;
      width:14px;height:14px;border-radius:50%;
      background:#fff;
      border:1px solid rgba(0,0,0,.4);
      cursor:pointer;
    }

    .right{display:flex;justify-content:flex-end;align-items:center;gap:10px;}
    .vol{display:flex;align-items:center;gap:10px;width:180px;color:var(--muted);font-weight:950;font-size:12px;}

    /* ====== SEARCH VIEW ====== */
    .chips{display:flex;flex-wrap:wrap;gap:10px;margin:10px 0 14px;}
    .chip{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      border-radius:999px;
      padding:10px 12px;
      font-weight:900;font-size:12px;
      cursor:pointer;user-select:none;
    }
    .chip.active{background:var(--accentSoft);border-color:rgba(75,163,238,.28);}

    .recentSearches{
      margin-top:6px;
      border:1px solid var(--border);
      border-radius:16px;
      background:rgba(255,255,255,.03);
      overflow:hidden;
    }
    .recentRow{
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.06);
      gap:10px;
    }
    .recentRow:last-child{border-bottom:none;}
    .recentRow .q{font-weight:950;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:0;}
    .recentRow .x{
      background:transparent;border:none;color:rgba(255,255,255,.7);
      cursor:pointer;font-size:16px;font-weight:900;
      padding:6px 10px;border-radius:10px;
    }
    .recentRow .x:hover{background:rgba(255,255,255,.06);}

    /* ====== LIBRARY TABS ====== */
    .tabs{display:flex;gap:10px;margin:6px 0 14px;}
    .tab{
      flex:0 0 auto;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      border-radius:999px;
      padding:10px 12px;
      font-weight:950;font-size:12px;
      cursor:pointer;user-select:none;
    }
    .tab.active{background:rgba(255,255,255,.12);border-color:rgba(255,255,255,.18);}

    .list{display:flex;flex-direction:column;gap:8px;}
    .listItem{
      display:flex;align-items:center;gap:12px;
      padding:10px 12px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
      border-radius:14px;
      cursor:pointer;user-select:none;
    }
    .listItem:hover{background:rgba(255,255,255,.05);}
    .thumb{
      width:46px;height:46px;border-radius:12px;overflow:hidden;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      flex:0 0 auto;
    }
    .thumb img{width:100%;height:100%;object-fit:cover;}
    .liMeta{min-width:0;display:flex;flex-direction:column;gap:2px;}
    .liMeta .liT{font-weight:950;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .liMeta .liS{color:var(--muted);font-weight:900;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

    /* ====== TOAST ====== */
    .toast{
      position:fixed;
      right:14px;
      bottom:calc(var(--desktopPlayerH) + 14px);
      background:rgba(20,20,20,.94);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:10px 12px;
      color:#eaeaea;
      box-shadow:var(--shadow);
      opacity:0;
      transform:translateY(10px);
      transition:all .15s ease;
      pointer-events:none;
      max-width:520px;
      font-weight:900;font-size:13px;
      z-index:220;
    }
    .toast.show{opacity:1;transform:translateY(0);}

    /* ====== UPLOAD MODAL ====== */
    .overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.62);
      display:none;align-items:center;justify-content:center;
      padding:18px;z-index:240;
    }
    .overlay.show{display:flex;}
    .modal{
      width:min(820px, 100%);
      background:rgba(12,12,12,.98);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding:14px 16px;display:flex;align-items:center;justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .modalHead .mtitle{font-weight:950}
    .modalBody{padding:16px}
    .formgrid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .field{display:flex;flex-direction:column;gap:8px;}
    .field label{
      font-size:12px;color:var(--muted);font-weight:950;letter-spacing:.08em;text-transform:uppercase;
    }
    .field input{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      padding:12px 12px;
      color:var(--text);
      outline:none;
      font-weight:900;
    }
    .field input::placeholder{color:rgba(255,255,255,.38)}
    .modalFoot{
      padding:14px 16px;display:flex;gap:10px;justify-content:flex-end;
      border-top:1px solid rgba(255,255,255,.10);
    }
    .smallnote{margin-top:10px;color:var(--muted);font-size:12px;font-weight:900;}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;font-size:12px;}

    /* ====== MOBILE NAV + MINI PLAYER ====== */
    .mobileNav{
      display:none;
      position:fixed;left:0;right:0;bottom:0;
      height:calc(var(--mobileNavH) + var(--safeBottom));
      background:rgba(10,10,10,.92);
      backdrop-filter:blur(10px);
      border-top:1px solid rgba(255,255,255,.10);
      padding-bottom:var(--safeBottom);
      z-index:210;
    }
    .mobileNav .bar{
      height:var(--mobileNavH);
      display:grid;grid-template-columns:repeat(4,1fr);
      gap:6px;padding:10px 10px 8px;align-items:center;
    }
    .mTab{
      border:none;background:transparent;color:rgba(255,255,255,.75);
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      gap:4px;font-weight:950;font-size:11px;
      cursor:pointer;user-select:none;
      padding:8px 6px;border-radius:12px;
    }
    .mTab.active{color:#fff;background:rgba(255,255,255,.06);}
    .mIcon{font-size:18px;line-height:1;}

    .miniPlayer{
      display:none;
      position:fixed;left:10px;right:10px;
      bottom:calc(var(--mobileNavH) + var(--safeBottom) + 10px);
      height:var(--miniPlayerH);
      background:rgba(16,16,16,.92);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      backdrop-filter:blur(10px);
      z-index:215;
      overflow:hidden;
      box-shadow:var(--shadow);
    }
    .miniInner{
      height:100%;
      display:grid;
      grid-template-columns:52px 1fr 140px;
      gap:10px;
      align-items:center;
      padding:10px 12px;
    }
    .miniArt{
      width:44px;height:44px;border-radius:12px;overflow:hidden;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
    }
    .miniArt img{width:100%;height:100%;object-fit:cover;}
    .miniMeta{min-width:0;}
    .miniMeta .t{font-weight:950;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .miniMeta .s{color:var(--muted);font-weight:900;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:3px;}
    .miniBtns{display:flex;gap:8px;justify-content:flex-end;align-items:center;}
    .miniBtn{
      position: relative;
      width:38px;height:38px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      user-select:none;font-weight:950;
      transition:transform .06s ease, background .12s ease;
    }
    .miniBtn:hover{background:rgba(255,255,255,.10);}
    .miniBtn:active{transform:scale(.98);}
        .miniBtn.accent:hover{background:rgba(75,163,238,.28);}
    .miniBtn.tiny{
      width:34px;height:34px;
      border-radius:14px;
      font-size:13px;
    }

    /* Mini progress bar */
    .miniProg{
      position:absolute;left:0;right:0;bottom:0;height:3px;
      background:rgba(255,255,255,.10);
    }
    .miniProg > div{
      height:100%;
      width:0%;
      background:var(--accent);
    }

    /* ====== NOW PLAYING SHEET (MOBILE) ====== */
    .sheetWrap{
      position:fixed;inset:0;
      display:none;
      z-index:230;
    }
    .sheetWrap.show{display:block;}
    .sheetBackdrop{
      position:absolute;inset:0;
      background:rgba(0,0,0,.55);
      opacity:0;
      transition:opacity .18s ease;
    }
    .sheetWrap.show .sheetBackdrop{opacity:1;}
    .sheet{
      position:absolute;left:0;right:0;bottom:0;
      height:calc(100vh - 10px);
      transform:translateY(102%);
      transition:transform .22s ease;
      background:
        radial-gradient(900px 500px at 10% 0%, rgba(75,163,238,.10), transparent 60%),
        linear-gradient(180deg,#0b0b0b,#000);
      border-top-left-radius:22px;
      border-top-right-radius:22px;
      border-top:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      touch-action:none;
    }
    .sheetWrap.show .sheet{transform:translateY(0);}
    .sheetHeader{
      padding:10px 14px 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .handle{
      width:44px;height:5px;border-radius:999px;
      background:rgba(255,255,255,.20);
      margin:6px auto 0;
    }
    .sheetTitle{
      font-weight:950;
      font-size:12px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:rgba(255,255,255,.7);
      text-align:center;
      flex:1;
      user-select:none;
    }
    .sheetIcon{
      width:40px;height:40px;border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;user-select:none;font-weight:950;
      transition:transform .06s ease, background .12s ease;
    }
    .sheetIcon:hover{background:rgba(255,255,255,.10);}
    .sheetIcon:active{transform:scale(.98);}

    .sheetTabs{
      display:flex;
      gap:10px;
      padding:0 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .sheetTab{
      border:none;
      background:transparent;
      color:rgba(255,255,255,.70);
      padding:10px 12px;
      border-radius:999px;
      font-weight:950;
      cursor:pointer;
      user-select:none;
    }
    .sheetTab.active{
      background:rgba(255,255,255,.10);
      color:#fff;
      border:1px solid rgba(255,255,255,.12);
    }

    .sheetBody{
      height:calc(100% - 108px);
      overflow:auto;
      padding:10px 16px 18px;
      padding-bottom:calc(var(--safeBottom) + 18px);
    }
    .npArt{
      width:min(84vw, 420px);
      aspect-ratio:1/1;
      border-radius:18px;
      margin:12px auto 16px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      box-shadow:var(--shadow);
    }
    .npArt img{width:100%;height:100%;object-fit:cover;}
    .npMeta{
      display:flex;align-items:flex-start;justify-content:space-between;
      gap:12px;
      width:min(90vw, 560px);
      margin:0 auto 10px;
    }
    .npMeta .left{min-width:0;}
    .npMeta .t{
      font-weight:950;
      font-size:18px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .npMeta .s{
      margin-top:6px;
      color:var(--muted);
      font-weight:900;
      font-size:13px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .npMeta .fav{
      width:44px;height:44px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;user-select:none;font-weight:950;
      transition:transform .06s ease, background .12s ease;
    }
    .npMeta .fav:hover{background:rgba(255,255,255,.10);}
    .npMeta .fav:active{transform:scale(.98);}

    .npTimeline{
      width:min(90vw, 560px);
      margin:8px auto 0;
      display:flex;flex-direction:column;gap:8px;
    }
    .npTimeRow{
      display:flex;align-items:center;justify-content:space-between;
      color:rgba(255,255,255,.60);
      font-weight:950;font-size:12px;
    }
    .npTimeline input[type="range"]{height:5px;}

    .npControls{
      width:min(90vw, 560px);
      margin:16px auto 0;
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;
    }
    .npBtn{
      position: relative;
      width:48px;height:48px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;user-select:none;font-weight:950;
      transition:transform .06s ease, background .12s ease;
    }
    .npBtn:hover{background:rgba(255,255,255,.10);}
    .npBtn:active{transform:scale(.98);}

    .npBtn svg{width:22px;height:22px;fill:currentColor;}
    .npBtn.big{background:var(--accentSolid);border-color:rgba(75,163,238,.55);color:#000;}
    .npBtn.big:hover{background:rgba(75,163,238,1);}
    .npBtn.big svg{width:26px;height:26px;}
    .miniBtn svg{width:18px;height:18px;fill:currentColor;}
    .miniBtn.accent{background:var(--accentSolid);border-color:rgba(75,163,238,.55);color:#000;}
    .miniBtn.accent:hover{background:rgba(75,163,238,1);}
        .npBtn.on{
      background:var(--accentSoft);
      border-color:rgba(75,163,238,.35);
    }

    .npSecondary{
      width:min(90vw, 560px);
      margin:16px auto 0;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      color:rgba(255,255,255,.65);
      font-weight:950;font-size:12px;
    }
    .npVol{
      width:min(90vw, 560px);
      margin:10px auto 0;
      display:flex;align-items:center;gap:10px;
      color:rgba(255,255,255,.65);
      font-weight:950;font-size:12px;
    }
    .npVol input[type="range"]{height:5px;}

    /* Sheet: Queue */
    .sheetQueue{
      width:min(92vw, 600px);
      margin:10px auto 0;
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      background:rgba(255,255,255,.03);
      overflow:hidden;
    }
    .qRow{
      display:grid;
      grid-template-columns:44px 1fr 40px;
      gap:10px;
      align-items:center;
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      cursor:pointer;
      user-select:none;
    }
    .qRow:last-child{border-bottom:none;}
    .qRow:hover{background:rgba(255,255,255,.05);}
    .qNum{color:rgba(255,255,255,.55);font-weight:950;font-size:12px;}
    .qMeta{min-width:0;display:flex;flex-direction:column;gap:2px;}
    .qMeta .qt{font-weight:950;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .qMeta .qs{color:var(--muted);font-weight:900;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .qKick{
      width:36px;height:36px;border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.05);
      display:flex;align-items:center;justify-content:center;
      font-weight:950;
      color:rgba(255,255,255,.75);
    }
    .qRow.now .qKick{
      background:var(--accentSoft);
      border-color:rgba(75,163,238,.35);
      color:#fff;
    }

    /* Sheet: Lyrics */
    .lyricsBox{
      width:min(92vw, 600px);
      margin:12px auto 0;
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      background:rgba(255,255,255,.03);
      padding:14px 14px;
    }
    .lyricsBox h4{
      margin:0 0 10px;
      font-size:12px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:rgba(255,255,255,.70);
    }
    .lyricsText{
      white-space:pre-wrap;
      color:rgba(255,255,255,.82);
      font-weight:800;
      line-height:1.55;
      font-size:14px;
    }
    .lyricsHint{
      margin-top:10px;
      color:rgba(255,255,255,.55);
      font-weight:900;
      font-size:12px;
    }

    
    /* Repeat-one badge */
    .iconBtn.one::after,
    .miniBtn.one::after,
    .npBtn.one::after{
      content:"1";
      position:absolute;
      right:10px;
      top:9px;
      font-size:10px;
      font-weight:950;
      color:currentColor;
      opacity:.95;
      pointer-events:none;
    }
    @media (max-width:760px){
      .miniBtn.one::after{ right:9px; top:8px; }
      .npBtn.one::after{ right:10px; top:10px; }
    }

/* ====== MOBILE BREAKPOINT ====== */
    @media (max-width:760px){
      body{overflow:hidden;}
      .app{grid-template-columns:1fr;grid-template-rows:1fr var(--desktopPlayerH);}
      .sidebar{display:none;}
      .main{grid-column:1;}
      .player{display:none;} /* hide desktop footer player on mobile */
      .topbar{padding:calc(10px + var(--safeTop)) 12px 10px;}
      .btn{padding:10px 12px;}
      .content{
        padding:12px;
        /* leave room for mini player + bottom nav */
        padding-bottom: calc(var(--miniPlayerH) + var(--mobileNavH) + var(--safeBottom) + 26px);
      }
      .grid{grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;}
      .card{padding:12px;}
      .bigtitle{font-size:30px;}
      .bigart{width:120px;height:120px;}
      .row{grid-template-columns:32px 1.8fr 0.9fr 64px; padding:10px 12px;}
      .toast{
        right:12px;
        bottom: calc(var(--miniPlayerH) + var(--mobileNavH) + var(--safeBottom) + 14px);
        max-width: calc(100vw - 24px);
      }
      .mobileNav{display:block;}
      .miniPlayer{display:block;}
    }
  
    /* ====== AUTH (GIS) ====== */
    .authArea{display:flex;align-items:center;gap:10px;}
    .userChip{
      display:none;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      cursor:pointer;
      user-select:none;
      max-width:320px;
      min-width:0;
    }
    .userChip.show{display:flex;}
    .userChip img{
      width:28px;height:28px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      object-fit:cover;
      background:rgba(255,255,255,.06);
      flex:0 0 auto;
    }
    .userChip .uMeta{min-width:0;display:flex;flex-direction:column;gap:1px;}
    .userChip .uName{font-weight:950;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .userChip .uRole{font-weight:950;font-size:11px;color:rgba(255,255,255,.60);text-transform:uppercase;letter-spacing:.08em;}
    .authMenu{
      position:fixed;
      top:calc(56px + var(--safeTop));
      right:18px;
      width:240px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(12,12,12,.98);
      box-shadow:var(--shadow);
      z-index:260;
      display:none;
      overflow:hidden;
    }
    .authMenu.show{display:block;}
    .authMenu .mi{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      font-weight:950;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .authMenu .mi:last-child{border-bottom:none;}
    .authMenu .mi small{color:var(--muted);font-weight:900;}

  </style>
<script src="https://accounts.google.com/gsi/client" async defer></script>
</head>

<body>
  <div class="app">
    <!-- DESKTOP SIDEBAR -->
    <aside class="sidebar">
      <div class="brand">
        <img src="assets/Current.png" alt="Current" />
        <div>
          <div class="name">Current</div>
          <div class="tag">Audio Streaming</div>
        </div>
      </div>

      <nav class="nav" id="nav">
        <a href="#home" data-route="home" class="active">Home</a>
        <a href="#search" data-route="search">Search</a>
        <a href="#library" data-route="library">Your Library</a>
        <a href="#queue" data-route="queue">Queue</a>
      </nav>

      <section class="libraryMini">
        <div class="libraryMiniHead">
          <h3>Playlists</h3>
          <span class="pill" id="plCount">‚Äî</span>
        </div>
        <div class="libraryMiniList" id="playlistList"></div>
      </section>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="topbar">
        <div class="searchbar" id="topSearchBar" title="Search">
          <span class="hint">‚åï</span>
          <input id="searchInput" type="text" placeholder="Search songs, artists, albums‚Ä¶" autocomplete="off" />
        </div>

        <div class="authArea" id="authArea">
          <!-- GIS renders into this div when logged out -->
          <div id="gsiButton"></div>

          <!-- Shown when logged in -->
          <div class="userChip" id="userChip" title="Account">
            <img id="userPic" alt="" src="/assets/Current.png" />
            <div class="uMeta">
              <div class="uName" id="userName">‚Äî</div>
              <div class="uRole" id="userRole">listener</div>
            </div>
          </div>
        </div>

        <div class="authMenu" id="authMenu" aria-hidden="true">
          <div class="mi"><span>Signed in</span><small id="userEmail">‚Äî</small></div>
          <div class="mi"><span>Role</span><small id="userRoleMenu">listener</small></div>
          <div class="mi"><button class="btn" id="logoutBtn" style="width:100%;justify-content:center;">Log out</button></div>
        </div>

        <button class="btn" id="uploadBtn" disabled title="Artists/Admins only">Upload</button>
        <button class="btn primary" id="refreshBtn">Refresh</button>
      </div>

      <div class="content">
        <!-- HOME -->
        <div id="view-home">
          <div class="sectionTitle">
            <h2>Home</h2>
            <div class="hint" id="homeHint">Catalog from DynamoDB ‚Üí CloudFront</div>
          </div>

          <div class="sectionTitle" style="margin-top:12px;">
            <h2>Recently Added</h2>
            <div class="hint" id="recentHint">‚Äî</div>
          </div>
          <div class="grid" id="recentGrid"></div>

          <div class="sectionTitle" style="margin-top:22px;">
            <h2>Artists</h2>
            <div class="hint" id="artistHint">‚Äî</div>
          </div>
          <div class="grid" id="artistGrid"></div>

          <div class="sectionTitle" style="margin-top:22px;">
            <h2>Albums</h2>
            <div class="hint" id="albumHint">‚Äî</div>
          </div>
          <div class="grid" id="albumGrid"></div>

          <div class="hint mono" style="margin-top:18px;">
            Tip: Space=play/pause, ‚Üê/‚Üí seek, ‚Üë/‚Üì volume, N/P next/prev.
          </div>
        </div>

        <!-- SEARCH -->
        <div id="view-search" style="display:none;">
          <div class="sectionTitle">
            <h2>Search</h2>
            <div class="hint" id="searchHint">Recent searches + category chips</div>
          </div>

          <div class="chips" id="chipRow"></div>

          <div class="sectionTitle" style="margin-top:14px;">
            <h2 style="font-size:18px;">Recent searches</h2>
            <div class="hint">
              <button class="btn" id="clearRecentBtn" style="padding:8px 12px;">Clear</button>
            </div>
          </div>
          <div class="recentSearches" id="recentSearches"></div>

          <div class="sectionTitle" style="margin-top:18px;">
            <h2 style="font-size:18px;">Browse results</h2>
            <div class="hint" id="searchCountHint">‚Äî</div>
          </div>

          <div class="grid" id="searchGrid"></div>

          <div class="table" id="searchTable">
            <div class="row head">
              <div>#</div><div>Title</div><div>Artist</div><div style="text-align:right;">Time</div>
            </div>
            <div id="searchRows"></div>
          </div>
        </div>

        <!-- LIBRARY -->
        <div id="view-library" style="display:none;">
          <div class="sectionTitle">
            <h2>Your Library</h2>
            <div class="hint" id="libHint">Grouped by Albums / Artists</div>
          </div>

          <div class="tabs">
            <button class="tab active" id="tabAlbums">Albums</button>
            <button class="tab" id="tabArtists">Artists</button>
          </div>

          <div id="libraryAlbums">
            <div class="list" id="libraryAlbumList"></div>
          </div>

          <div id="libraryArtists" style="display:none;">
            <div class="list" id="libraryArtistList"></div>
          </div>

          <div class="table" style="margin-top:18px;">
            <div class="row head">
              <div>#</div><div>Title</div><div>Artist</div><div style="text-align:right;">Time</div>
            </div>
            <div id="libRows"></div>
          </div>
        </div>

        <!-- QUEUE -->
        <div id="view-queue" style="display:none;">
          <div class="sectionTitle">
            <h2>Queue</h2>
            <div class="hint" id="queueHint">Click to play ‚Ä¢ Shift=Play next ‚Ä¢ Ctrl/Cmd=Add</div>
          </div>
          <div class="table">
            <div class="row head">
              <div>#</div><div>Title</div><div>Artist</div><div style="text-align:right;">Time</div>
            </div>
            <div id="queueRows"></div>
          </div>
        </div>

        <!-- ALBUM DETAIL -->
        <div id="view-album" style="display:none;">
          <div class="pageHero">
            <div class="bigart"><img id="albumArt" alt="" src="/assets/Current.png" /></div>
            <div class="meta">
              <div class="kicker">Album</div>
              <div class="bigtitle" id="albumTitle">‚Äî</div>
              <div class="bigsub" id="albumSub">‚Äî</div>
              <div class="actions">
                <button class="btn primary" id="albumPlayBtn">Play</button>
                <button class="btn" id="albumBackBtn">Back</button>
              </div>
            </div>
          </div>
          <div class="table">
            <div class="row head">
              <div>#</div><div>Title</div><div>Artist</div><div style="text-align:right;">Time</div>
            </div>
            <div id="albumRows"></div>
          </div>
        </div>

        <!-- ARTIST DETAIL -->
        <div id="view-artist" style="display:none;">
          <div class="pageHero">
            <div class="bigart"><img id="artistArt" alt="" src="/assets/Current.png" /></div>
            <div class="meta">
              <div class="kicker">Artist</div>
              <div class="bigtitle" id="artistTitle">‚Äî</div>
              <div class="bigsub" id="artistSub">‚Äî</div>
              <div class="actions">
                <button class="btn primary" id="artistPlayBtn">Play Top</button>
                <button class="btn" id="artistBackBtn">Back</button>
              </div>
            </div>
          </div>

          <div class="sectionTitle">
            <h2>Albums</h2>
            <div class="hint" id="artistAlbumHint">‚Äî</div>
          </div>
          <div class="grid" id="artistAlbumGrid"></div>

          <div class="sectionTitle" style="margin-top:22px;">
            <h2>Top Tracks</h2>
            <div class="hint">(sorted by album + track #)</div>
          </div>
          <div class="table">
            <div class="row head">
              <div>#</div><div>Title</div><div>Artist</div><div style="text-align:right;">Time</div>
            </div>
            <div id="artistRows"></div>
          </div>
        </div>
      </div>
    </main>

    <!-- DESKTOP PLAYER (hidden on mobile) -->
    <footer class="player">
      <div class="now">
        <div class="art"><img id="nowArt" alt="" src="/assets/Current.png" /></div>
        <div class="meta">
          <div class="t" id="nowTitle">Nothing playing</div>
          <div class="s" id="nowSub">‚Äî</div>
        </div>
      </div>

      <div class="controls">
        <div class="ctrlRow">
          <button class="iconBtn" id="btnShuffle" title="Shuffle">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M16 3h5v5h-2V6.41l-3.29 3.3-1.42-1.42L17.59 5H16V3z"/>
              <path d="M4 6h5v2H4V6zM4 16h5v2H4v-2z"/>
              <path d="M16 21v-2h1.59l-3.29-3.29 1.42-1.42L19 17.59V16h2v5h-5z"/>
              <path d="M14.29 14.29 10 10 4 16v-3H2v5h5v-2H5.41l4.59-4.59 2.88 2.88 1.41-1.41z"/>
            </svg>
          </button>

          <button class="iconBtn" id="btnPrev" title="Previous">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6 6v12h2V6H6zm3.5 6l8.5 6V6l-8.5 6z"/></svg>
          </button>

          <button class="iconBtn playBtn" id="btnPlay" title="Play / Pause">
            <svg id="iconPlay" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M8 5v14l11-7z"/>
            </svg>
          </button>

          <button class="iconBtn" id="btnNext" title="Next">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M16 6v12h2V6h-2zM6 6v12l8.5-6L6 6z"/></svg>
          </button>

          <button class="iconBtn" id="btnRepeat" title="Repeat">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M17 17h-10v-3l-4 4 4 4v-3h10v-2zm0-10v3l4-4-4-4v3h-10v2h10z"/>
            </svg>
          </button>

        </div>
        <div class="timeline">
          <span id="curTime">0:00</span>
          <input id="seek" type="range" min="0" max="100" value="0" step="1" />
          <span id="durTime">0:00</span>
        </div>
      </div>

      <div class="right">
        <div class="vol">
          <span>VOL</span>
          <input id="vol" type="range" min="0" max="1" step="0.01" value="0.9" />
        </div>
      </div>

      <audio id="audio" preload="metadata"></audio>
    </footer>
  </div>

  <!-- MOBILE MINI PLAYER -->
  <div class="miniPlayer" id="miniPlayer" role="button" aria-label="Now playing">
    <div class="miniInner">
      <div class="miniArt"><img id="miniArt" alt="" src="/assets/Current.png"></div>
      <div class="miniMeta">
        <div class="t" id="miniTitle">Nothing playing</div>
        <div class="s" id="miniSub">‚Äî</div>
      </div>
      <div class="miniBtns" aria-label="Mini controls">
        <button class="miniBtn tiny" id="miniShuffleBtn" title="Shuffle">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M16 3h5v5h-2V6.41l-3.29 3.3-1.42-1.42L17.59 5H16V3z"/>
            <path d="M4 6h5v2H4V6zM4 16h5v2H4v-2z"/>
            <path d="M16 21v-2h1.59l-3.29-3.29 1.42-1.42L19 17.59V16h2v5h-5z"/>
            <path d="M14.29 14.29 10 10 4 16v-3H2v5h5v-2H5.41l4.59-4.59 2.88 2.88 1.41-1.41z"/>
          </svg>
        </button>
        <button class="miniBtn accent" id="miniPlayBtn" title="Play/Pause">
          <svg id="miniIconPlay" viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>
        </button>
        <button class="miniBtn tiny" id="miniNextBtn" title="Next">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M16 6v12h2V6h-2zM6 6v12l8.5-6L6 6z"/></svg>
        </button>
        <button class="miniBtn tiny" id="miniRepeatBtn" title="Repeat">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M17 17h-10v-3l-4 4 4 4v-3h10v-2zm0-10v3l4-4-4-4v3h-10v2h10z"/></svg>
        </button>
      </div>
    </div>
    <div class="miniProg"><div id="miniProgFill"></div></div>
  </div>

  <!-- MOBILE BOTTOM NAV -->
  <div class="mobileNav" id="mobileNav">
    <div class="bar">
      <button class="mTab active" data-route="home" id="mHome"><span class="mIcon">‚åÇ</span><span>Home</span></button>
      <button class="mTab" data-route="search" id="mSearch"><span class="mIcon">‚åï</span><span>Search</span></button>
      <button class="mTab" data-route="library" id="mLibrary"><span class="mIcon">‚ò∞</span><span>Library</span></button>
      <button class="mTab" data-route="queue" id="mQueue"><span class="mIcon">‚â°</span><span>Queue</span></button>
    </div>
  </div>

  <!-- NOW PLAYING SHEET -->
  <div class="sheetWrap" id="sheetWrap" aria-hidden="true">
    <div class="sheetBackdrop" id="sheetBackdrop"></div>
    <div class="sheet" id="sheet">
      <div class="handle" id="sheetHandle"></div>
      <div class="sheetHeader">
        <button class="sheetIcon" id="sheetCloseBtn" title="Close">‚åÑ</button>
        <div class="sheetTitle">Now Playing</div>
        <button class="sheetIcon" id="sheetQueueBtn" title="Queue">‚â°</button>
      </div>

      <div class="sheetTabs">
        <button class="sheetTab active" id="sheetTabNow">Now</button>
        <button class="sheetTab" id="sheetTabQueue">Queue</button>
        <button class="sheetTab" id="sheetTabLyrics">Lyrics</button>
      </div>

      <div class="sheetBody">
        <!-- TAB: NOW -->
        <div id="sheetViewNow">
          <div class="npArt"><img id="npArt" alt="" src="/assets/Current.png"></div>

          <div class="npMeta">
            <div class="left">
              <div class="t" id="npTitle">Nothing playing</div>
              <div class="s" id="npSub">‚Äî</div>
            </div>
            <button class="fav" id="npFavBtn" title="Like (local)">‚ô°</button>
          </div>

          <div class="npTimeline">
            <input id="npSeek" type="range" min="0" max="100" value="0" step="1" />
            <div class="npTimeRow">
              <span id="npCur">0:00</span>
              <span id="npDur">0:00</span>
            </div>
          </div>

          <div class="npControls">
            <button class="npBtn" id="npShuffleBtn" title="Shuffle">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M16 3h5v5h-2V6.41l-3.29 3.3-1.42-1.42L17.59 5H16V3z"/>
                <path d="M4 6h5v2H4V6zm0 10h5v2H4v-2z"/>
                <path d="M16 21v-2h1.59l-3.29-3.29 1.42-1.42L19 17.59V16h2v5h-5z"/>
                <path d="M14.29 14.29 10 10 4 16v-3H2v5h5v-2H5.41l4.59-4.59 2.88 2.88 1.41-1.41z"/>
              </svg>
            </button>
            <button class="npBtn" id="npPrevBtn" title="Previous">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6 6v12h2V6H6zm3.5 6l8.5 6V6l-8.5 6z"/></svg>
            </button>
            <button class="npBtn big" id="npPlayBtn" title="Play/Pause">
              <svg id="npIconPlay" viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>
            </button>
            <button class="npBtn" id="npNextBtn" title="Next">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M16 6v12h2V6h-2zM6 6v12l8.5-6L6 6z"/></svg>
            </button>
            <button class="npBtn" id="npRepeatBtn" title="Repeat">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M17 17h-10v-3l-4 4 4 4v-3h10v-2zm0-10v3l4-4-4-4v3h-10v2h10z"/></svg>
            </button>
          </div>

          <div class="npSecondary">
            <div>Volume</div>
            <div class="hint" id="npVolHint">‚Äî</div>
          </div>
          <div class="npVol">
            <span style="width:34px;text-align:center;">üîà</span>
            <input id="npVol" type="range" min="0" max="1" step="0.01" value="0.9" />
            <span style="width:34px;text-align:center;">üîä</span>
          </div>
        </div>

        <!-- TAB: QUEUE -->
        <div id="sheetViewQueue" style="display:none;">
          <div class="hint" style="margin:8px auto 6px; width:min(92vw,600px);">
            Tap a track to jump ‚Ä¢ Long-press/drag reorder is next step (optional)
          </div>
          <div class="sheetQueue" id="sheetQueueList"></div>
        </div>

        <!-- TAB: LYRICS -->
        <div id="sheetViewLyrics" style="display:none;">
          <div class="lyricsBox">
            <h4>Lyrics</h4>
            <div class="lyricsText" id="lyricsText">No lyrics found for this track.</div>
            <div class="lyricsHint mono">
              Add lyrics to DynamoDB later (e.g., item.lyrics) and they will show here automatically.
            </div>
          </div>
        </div>

        <div class="hint mono" style="margin-top:18px;">
          Tip: Swipe down to close. Queue tab stays inside the player.
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- UPLOAD MODAL -->
  <div class="overlay" id="uploadOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <div class="mtitle">Upload Track</div>
        <button class="iconbtn" id="uploadCloseBtn" title="Close">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="formgrid">
          <div class="field">
            <label>Song title</label>
            <input id="fTitle" placeholder="e.g. Wires">
          </div>
          <div class="field">
            <label>Artist</label>
            <input id="fArtist" placeholder="e.g. Hand Of Taurus">
          </div>
          <div class="field">
            <label>Album</label>
            <input id="fAlbum" placeholder="e.g. Currents Vol. 1">
          </div>
          <div class="field">
            <label>Track number</label>
            <input id="fTrackNo" type="number" min="1" placeholder="1">
          </div>
          <div class="field">
            <label>Release year</label>
            <input id="fYear" type="number" min="1900" max="2100" placeholder="2025">
          </div>
          <div class="field">
            <label>Album art (‚â§ 3000√ó3000)</label>
            <input id="fArt" type="file" accept="image/*">
          </div>
          <div class="field" style="grid-column:1 / 3;">
            <label>Audio file (MP3/FLAC/WAV/MP4/M4A/AAC/OGG)</label>
            <input id="fAudio" type="file" accept=".mp3,.flac,.wav,.mp4,.m4a,.aac,.ogg,audio/*,video/mp4">
          </div>
        </div>

        <div class="smallnote" id="uploadNote">
          Fill required fields, then upload.
        </div>
      </div>
      <div class="modalFoot">
        <button class="btn" id="uploadCancelBtn" type="button">Cancel</button>
        <button class="btn primary" id="uploadSubmitBtn" type="button" disabled>Upload</button>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const API_BASE = "https://czzz7fhbn6.execute-api.us-east-1.amazonaws.com";
    const TRACKS_ENDPOINT = "/tracks";
    const UPLOADS_INIT_ENDPOINT = "/uploads/init";

    

    // ===== AUTH (Google Identity Services) =====
    // 1) Create a Google OAuth Client ID (Web) in Google Cloud Console.
    // 2) Put it here (public) ‚Äî this is safe to expose.
    const GOOGLE_CLIENT_ID = "PASTE_YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com";

    // Your API must implement these (see server code below):
    //   POST /auth/google  { credential } -> { token, user }
    //   GET  /me           (Authorization: Bearer <token>) -> { user }
    //   POST /auth/logout  (optional)
    const AUTH_GOOGLE_ENDPOINT = "/auth/google";
    const AUTH_ME_ENDPOINT     = "/me";
    const AUTH_LOGOUT_ENDPOINT = "/auth/logout";

    const AUTH_TOKEN_KEY = "current_auth_token_v1";

    const auth = {
      token: null,
      user: null,  // { sub, email, name, picture, role }
    };

    function isAdmin(){ return auth.user?.role === "admin"; }
    function isArtist(){ return auth.user?.role === "artist" || isAdmin(); }
    function isListener(){ return !!auth.user; } // logged-in user is at least listener

    function setAuthToken(t){
      auth.token = t || null;
      if (auth.token) localStorage.setItem(AUTH_TOKEN_KEY, auth.token);
      else localStorage.removeItem(AUTH_TOKEN_KEY);
    }

    function applyAuthUI(){
      // Toggle Upload privilege (artist/admin only)
      if (els.uploadBtn){
        if (isArtist()){
          els.uploadBtn.disabled = false;
          els.uploadBtn.title = "Upload (artist/admin)";
        } else {
          els.uploadBtn.disabled = true;
          els.uploadBtn.title = auth.user ? "Upload is for Artists/Admins" : "Sign in to upload";
        }
      }

      // Toggle GIS button vs user chip
      const gsiButton = document.getElementById("gsiButton");
      const userChip  = document.getElementById("userChip");
      const userPic   = document.getElementById("userPic");
      const userName  = document.getElementById("userName");
      const userRole  = document.getElementById("userRole");
      const userEmail = document.getElementById("userEmail");
      const userRoleMenu = document.getElementById("userRoleMenu");

      if (!auth.user){
        if (gsiButton) gsiButton.style.display = "block";
        if (userChip) userChip.classList.remove("show");
        if (userPic) userPic.src = FALLBACK_ART;
        if (userName) userName.textContent = "‚Äî";
        if (userRole) userRole.textContent = "listener";
        if (userEmail) userEmail.textContent = "‚Äî";
        if (userRoleMenu) userRoleMenu.textContent = "listener";
        return;
      }

      if (gsiButton) gsiButton.style.display = "none";
      if (userChip) userChip.classList.add("show");
      if (userPic) userPic.src = artOrFallback(auth.user.picture);
      if (userName) userName.textContent = auth.user.name || auth.user.email || "User";
      if (userRole) userRole.textContent = auth.user.role || "listener";
      if (userEmail) userEmail.textContent = auth.user.email || "‚Äî";
      if (userRoleMenu) userRoleMenu.textContent = auth.user.role || "listener";
    }

    function closeAuthMenu(){
      const menu = document.getElementById("authMenu");
      if (menu) menu.classList.remove("show");
    }
    function toggleAuthMenu(){
      const menu = document.getElementById("authMenu");
      if (!menu) return;
      menu.classList.toggle("show");
    }

    async function apiFetch(path, opts = {}){
      const url = apiUrl(path);
      const headers = new Headers(opts.headers || {});
      if (auth.token) headers.set("Authorization", `Bearer ${auth.token}`);
      if (!headers.has("Content-Type") && opts.body && typeof opts.body === "string"){
        headers.set("Content-Type","application/json");
      }
      const res = await fetch(url, { ...opts, headers, credentials:"omit" });
      return res;
    }

    async function authMe(){
      if (!auth.token) return null;
      const res = await apiFetch(AUTH_ME_ENDPOINT, { method:"GET" });
      if (!res.ok){
        // token invalid/expired
        setAuthToken(null);
        auth.user = null;
        applyAuthUI();
        return null;
      }
      const data = await res.json().catch(()=> ({}));
      auth.user = data.user || null;
      applyAuthUI();
      return auth.user;
    }

    async function authWithGoogleCredential(credential){
      const res = await fetch(apiUrl(AUTH_GOOGLE_ENDPOINT), {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ credential }),
      });
      if (!res.ok){
        const txt = await res.text().catch(()=> "");
        throw new Error(`Auth failed: ${res.status} ${res.statusText} ${txt}`);
      }
      const data = await res.json().catch(()=> ({}));
      if (!data.token || !data.user) throw new Error("Auth response missing token/user.");
      setAuthToken(data.token);
      auth.user = data.user;
      applyAuthUI();
      return data.user;
    }

    async function logout(){
      try{
        if (auth.token){
          await apiFetch(AUTH_LOGOUT_ENDPOINT, { method:"POST" }).catch(()=>{});
        }
      } finally {
        setAuthToken(null);
        auth.user = null;
        applyAuthUI();
        closeAuthMenu();
        // re-render GIS button if needed
        renderGsiButton();
        toast("Logged out.");
      }
    }

    function handleCredentialResponse(response){
      // response.credential is the Google ID token (JWT)
      if (!response?.credential) return;
      authWithGoogleCredential(response.credential)
        .then(u => toast(`Welcome, ${u.name || u.email || "user"}!`))
        .catch(err => { console.error(err); toast(err.message || "Login failed"); });
    }

    function renderGsiButton(){
      const mount = document.getElementById("gsiButton");
      if (!mount) return;
      mount.innerHTML = "";
      if (!window.google?.accounts?.id) return;

      // Initialize once per page
      google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: handleCredentialResponse,
        ux_mode: "popup",
      });

      // Render the standard button
      google.accounts.id.renderButton(mount, {
        theme: "outline",
        size: "large",
        shape: "pill",
        width: 210,
        text: "signin_with",
      });

      // Optional One Tap prompt (comment out if you don't want it)
      // google.accounts.id.prompt();
    }

    async function initAuth(){
      // menu + close on outside click
      const userChip = document.getElementById("userChip");
      const logoutBtn = document.getElementById("logoutBtn");

      if (userChip){
        userChip.addEventListener("click", (e)=>{ e.stopPropagation(); toggleAuthMenu(); });
      }
      if (logoutBtn){
        logoutBtn.addEventListener("click", (e)=>{ e.preventDefault(); logout(); });
      }
      document.addEventListener("click", closeAuthMenu);

      // Load token from storage
      const saved = localStorage.getItem(AUTH_TOKEN_KEY);
      if (saved) auth.token = saved;

      // If we have a token, validate /me; else show GIS button
      if (auth.token){
        await authMe();
      }
      applyAuthUI();
      renderGsiButton();
    }

const FALLBACK_ART = "/assets/Current.png";

    const ICONS = {
      shuffle: `
        <svg viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M16 3h5v5" />
          <path d="M21 3l-5.5 5.5" />
          <path d="M4 6h2.5c1.1 0 2.2.4 3 1.2l9 9c.8.8 1.9 1.2 3 1.2H20" />
          <path d="M16 21h5v-5" />
          <path d="M21 21l-5.5-5.5" />
          <path d="M4 18h2.5c1.1 0 2.2-.4 3-1.2l1.7-1.7" />
        </svg>`,
      repeat: `
        <svg viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M17 1l4 4-4 4" />
          <path d="M3 11V9a4 4 0 0 1 4-4h14" />
          <path d="M7 23l-4-4 4-4" />
          <path d="M21 13v2a4 4 0 0 1-4 4H3" />
        </svg>`
    };

    function artOrFallback(url){
      const s = (url ?? "").toString().trim();
      return s ? s : FALLBACK_ART;
    }
    function bindImgFallback(img){
      if (!img) return;
      img.addEventListener("error", ()=>{
        try{
          const cur = (img.getAttribute("src") || "").toString();
          if (cur.includes(FALLBACK_ART)) return;
        }catch{}
        img.setAttribute("src", FALLBACK_ART);
        img.style.display = "block";
      });
    }

    // ===== SEARCH SETTINGS =====
    const SEARCH_RECENTS_KEY = "current_recent_searches_v2";
    const MAX_RECENTS = 8;

    const CATEGORY_CHIPS = [
      { label: "All", q: "" },
      { label: "Recently Added", q: "__recent__" },
      { label: "Artists", q: "__artists__" },
      { label: "Albums", q: "__albums__" },
      { label: "Singles", q: "__singles__" },
      { label: "2025", q: "2025" },
      { label: "Instrumental", q: "instrumental" },
      { label: "Live", q: "live" },
    ];

    // ===== DOM =====
    const els = {
      nav: document.getElementById("nav"),
      mTabs: [...document.querySelectorAll(".mTab")],

      views: {
        home: document.getElementById("view-home"),
        search: document.getElementById("view-search"),
        library: document.getElementById("view-library"),
        queue: document.getElementById("view-queue"),
        album: document.getElementById("view-album"),
        artist: document.getElementById("view-artist"),
      },

      searchInput: document.getElementById("searchInput"),

      recentGrid: document.getElementById("recentGrid"),
      artistGrid: document.getElementById("artistGrid"),
      albumGrid: document.getElementById("albumGrid"),
      recentHint: document.getElementById("recentHint"),
      artistHint: document.getElementById("artistHint"),
      albumHint: document.getElementById("albumHint"),

      chipRow: document.getElementById("chipRow"),
      recentSearches: document.getElementById("recentSearches"),
      clearRecentBtn: document.getElementById("clearRecentBtn"),
      searchCountHint: document.getElementById("searchCountHint"),
      searchGrid: document.getElementById("searchGrid"),
      searchRows: document.getElementById("searchRows"),

      tabAlbums: document.getElementById("tabAlbums"),
      tabArtists: document.getElementById("tabArtists"),
      libraryAlbums: document.getElementById("libraryAlbums"),
      libraryArtists: document.getElementById("libraryArtists"),
      libraryAlbumList: document.getElementById("libraryAlbumList"),
      libraryArtistList: document.getElementById("libraryArtistList"),
      libHint: document.getElementById("libHint"),
      libRows: document.getElementById("libRows"),

      queueRows: document.getElementById("queueRows"),
      queueHint: document.getElementById("queueHint"),

      playlistList: document.getElementById("playlistList"),
      plCount: document.getElementById("plCount"),

      albumArt: document.getElementById("albumArt"),
      albumTitle: document.getElementById("albumTitle"),
      albumSub: document.getElementById("albumSub"),
      albumRows: document.getElementById("albumRows"),
      albumPlayBtn: document.getElementById("albumPlayBtn"),
      albumBackBtn: document.getElementById("albumBackBtn"),

      artistArt: document.getElementById("artistArt"),
      artistTitle: document.getElementById("artistTitle"),
      artistSub: document.getElementById("artistSub"),
      artistAlbumGrid: document.getElementById("artistAlbumGrid"),
      artistRows: document.getElementById("artistRows"),
      artistAlbumHint: document.getElementById("artistAlbumHint"),
      artistPlayBtn: document.getElementById("artistPlayBtn"),
      artistBackBtn: document.getElementById("artistBackBtn"),

      refreshBtn: document.getElementById("refreshBtn"),
      uploadBtn: document.getElementById("uploadBtn"),

      audio: document.getElementById("audio"),

      // desktop controls
      playBtn: document.getElementById("playBtn") || document.getElementById("btnPlay"),
      prevBtn: document.getElementById("prevBtn") || document.getElementById("btnPrev"),
      nextBtn: document.getElementById("nextBtn") || document.getElementById("btnNext"),
      shuffleBtn: document.getElementById("shuffleBtn") || document.getElementById("btnShuffle"),
      repeatBtn: document.getElementById("repeatBtn") || document.getElementById("btnRepeat"),
      nowTitle: document.getElementById("nowTitle"),
      nowSub: document.getElementById("nowSub"),
      nowArt: document.getElementById("nowArt"),
      seek: document.getElementById("seek"),
      vol: document.getElementById("vol"),
      curTime: document.getElementById("curTime"),
      durTime: document.getElementById("durTime"),

      // mini player
      miniPlayer: document.getElementById("miniPlayer"),
      miniArt: document.getElementById("miniArt"),
      miniTitle: document.getElementById("miniTitle"),
      miniSub: document.getElementById("miniSub"),
      miniShuffleBtn: document.getElementById("miniShuffleBtn"),
      miniPlayBtn: document.getElementById("miniPlayBtn"),
      miniNextBtn: document.getElementById("miniNextBtn"),
      miniRepeatBtn: document.getElementById("miniRepeatBtn"),
      miniProgFill: document.getElementById("miniProgFill"),

      // sheet
      sheetWrap: document.getElementById("sheetWrap"),
      sheetBackdrop: document.getElementById("sheetBackdrop"),
      sheet: document.getElementById("sheet"),
      sheetCloseBtn: document.getElementById("sheetCloseBtn"),
      sheetQueueBtn: document.getElementById("sheetQueueBtn"),

      sheetTabNow: document.getElementById("sheetTabNow"),
      sheetTabQueue: document.getElementById("sheetTabQueue"),
      sheetTabLyrics: document.getElementById("sheetTabLyrics"),
      sheetViewNow: document.getElementById("sheetViewNow"),
      sheetViewQueue: document.getElementById("sheetViewQueue"),
      sheetViewLyrics: document.getElementById("sheetViewLyrics"),

      npArt: document.getElementById("npArt"),
      npTitle: document.getElementById("npTitle"),
      npSub: document.getElementById("npSub"),
      npFavBtn: document.getElementById("npFavBtn"),
      npSeek: document.getElementById("npSeek"),
      npCur: document.getElementById("npCur"),
      npDur: document.getElementById("npDur"),
      npShuffleBtn: document.getElementById("npShuffleBtn"),
      npPrevBtn: document.getElementById("npPrevBtn"),
      npPlayBtn: document.getElementById("npPlayBtn"),
      npNextBtn: document.getElementById("npNextBtn"),
      npRepeatBtn: document.getElementById("npRepeatBtn"),
      npVol: document.getElementById("npVol"),
      npVolHint: document.getElementById("npVolHint"),
      sheetQueueList: document.getElementById("sheetQueueList"),
      lyricsText: document.getElementById("lyricsText"),

      toast: document.getElementById("toast"),

      uploadOverlay: document.getElementById("uploadOverlay"),
      uploadCloseBtn: document.getElementById("uploadCloseBtn"),
      uploadCancelBtn: document.getElementById("uploadCancelBtn"),
      uploadSubmitBtn: document.getElementById("uploadSubmitBtn"),
      fTitle: document.getElementById("fTitle"),
      fArtist: document.getElementById("fArtist"),
      fAlbum: document.getElementById("fAlbum"),
      fTrackNo: document.getElementById("fTrackNo"),
      fYear: document.getElementById("fYear"),
      fArt: document.getElementById("fArt"),
      fAudio: document.getElementById("fAudio"),
      uploadNote: document.getElementById("uploadNote"),
    };

    // ===== STATE =====
    const state = {
      tracks: [],
      queue: [],
      queueIndex: -1,
      filteredTracks: [],
      isSeekingDesktop: false,
      isSeekingSheet: false,

      artists: [],
      albums: [],
      tracksByAlbumKey: new Map(),
      tracksByArtistKey: new Map(),

      lastNonDetailRoute: "home",
      activeAlbumKey: null,
      activeArtistKey: null,
      activeChip: "All",

      // local "likes" (UI only)
      likesKey: "current_likes_v1",
      likes: new Set(),

      // playback modes
      shuffle: false,
      repeat: "off", // off | all | one
      playedHistory: [],

      // sheet drag
      sheetOpen: false,
      sheetDrag: { active:false, startY:0, curY:0 },
    };

    // ===== HELPERS =====
    const esc = (str) => String(str ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");

    function toast(msg){
      els.toast.textContent = msg;
      els.toast.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> els.toast.classList.remove("show"), 2600);
    }

    function fmtTime(sec){
      if (!isFinite(sec) || sec < 0) return "0:00";
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return `${m}:${String(s).padStart(2,"0")}`;
    }

    function slug(s){
      return String(s ?? "")
        .trim().toLowerCase()
        .replace(/['"]/g,"")
        .replace(/[^a-z0-9]+/g,"-")
        .replace(/(^-|-$)/g,"") || "unknown";
    }

    function apiUrl(path){
      const base = API_BASE ? API_BASE.replace(/\/$/,"") : "";
      return base + path;
    }

    function titleFromStreamUrl(url){
      try{
        const name = decodeURIComponent(url.split("/").pop() || "");
        return name.replace(/\.[a-z0-9]+$/i, "") || "Untitled";
      }catch{ return "Untitled"; }
    }

    function normalizeTrack(t, idx){
      const trackId = t.track_id ?? t.id ?? t.trackId ?? String(idx);
      const streamUrl = t.stream_url ?? t.audioUrl ?? t.url ?? t.playUrl ?? "";
      const title = t.title ?? t.song_title ?? t.name ?? (streamUrl ? titleFromStreamUrl(streamUrl) : "Untitled");
      const artist = String(t.artist ?? "Unknown Artist").trim();
      const album  = String(t.album  ?? "Unknown Album").trim();
      const year   = t.release_year ?? t.year ?? null;

      const art = t.art_url ?? t.coverUrl ?? t.artUrl ?? "";
      const trackNoRaw = t.track_number ?? t.trackNo ?? t.track ?? null;
      const trackNumber = (trackNoRaw === null || trackNoRaw === undefined || trackNoRaw === "") ? null : Number(trackNoRaw);
      const duration = t.duration ?? null;

      const lyrics = t.lyrics ?? t.lyric ?? t.text ?? null;

      const artistKey = `artist:${slug(artist)}`;
      const albumKey  = `album:${slug(artist)}:${slug(album)}`;

      return {
        id: trackId,
        track_id: trackId,
        title, artist, album,
        release_year: year,
        track_number: isFinite(trackNumber) ? trackNumber : null,
        duration: isFinite(Number(duration)) ? Number(duration) : null,
        stream_url: streamUrl,
        art_url: art,
        lyrics,
        artist_key: artistKey,
        album_key: albumKey,
      };
    }

    function isMobile(){
      return window.matchMedia && window.matchMedia("(max-width: 760px)").matches;
    }

    // ===== LIKES (local) =====
    function loadLikes(){
      try{
        const raw = localStorage.getItem(state.likesKey);
        const arr = raw ? JSON.parse(raw) : [];
        state.likes = new Set(Array.isArray(arr) ? arr : []);
      }catch{ state.likes = new Set(); }
    }
    function persistLikes(){
      try{ localStorage.setItem(state.likesKey, JSON.stringify([...state.likes])); }catch{}
    }
    function setFavUI(trackId){
      const liked = state.likes.has(trackId);
      els.npFavBtn.textContent = liked ? "‚ô•" : "‚ô°";
    }

    // ===== PLAYBACK MODES (persist) =====
    const MODE_KEY = "current_playback_modes_v1";
    function loadModes(){
      try{
        const raw = localStorage.getItem(MODE_KEY);
        const obj = raw ? JSON.parse(raw) : {};
        state.shuffle = !!obj.shuffle;
        state.repeat = ["off","all","one"].includes(obj.repeat) ? obj.repeat : "off";
      }catch{}
      syncModeUI();
    }
    function persistModes(){
      try{
        localStorage.setItem(MODE_KEY, JSON.stringify({shuffle: state.shuffle, repeat: state.repeat}));
      }catch{}
    }
    function cycleRepeat(){
      state.repeat = (state.repeat === "off") ? "all" : (state.repeat === "all" ? "one" : "off");
      persistModes();
      syncModeUI();
      toast(`Repeat: ${state.repeat}`);
    }
    function toggleShuffle(){
      state.shuffle = !state.shuffle;
      persistModes();
      syncModeUI();
      toast(`Shuffle: ${state.shuffle ? "on" : "off"}`);
    }

    function syncModeUI(){
  const sh = state.shuffle;
  const rp = state.repeat;

  const setShuffle = (btn) => {
    if (!btn) return;
    btn.innerHTML = ICONS.shuffle;
    btn.classList.toggle("on", sh);
  };

  const setRepeat = (btn) => {
    if (!btn) return;
    btn.innerHTML = ICONS.repeat;
    btn.classList.toggle("on", rp !== "off");
    btn.classList.toggle("one", rp === "one");
  };

  // Desktop
  setShuffle(els.shuffleBtn);
  setRepeat(els.repeatBtn);

  // Mini
  setShuffle(els.miniShuffleBtn);
  setRepeat(els.miniRepeatBtn);

  // Sheet
  setShuffle(els.npShuffleBtn);
  setRepeat(els.npRepeatBtn);
}

    // ===== RENDERERS =====
    function cardHTML({kind, key, title, subtitle, art_url, playHint}){
      const art = `<img src="${esc(artOrFallback(art_url))}" alt="">`;
      const fab = playHint ? `<div class="playFab" title="${esc(playHint)}">‚ñ∂</div>` : "";
      return `
        <div class="card" data-kind="${esc(kind)}" data-key="${esc(key)}">
          <div class="cover">${art}${fab}</div>
          <div class="tTitle">${esc(title)}</div>
          <div class="tSub">${esc(subtitle || "‚Äî")}</div>
        </div>
      `;
    }

    function trackRowHTML(t, idx, contextKey=""){
      const dur = t.duration ? fmtTime(t.duration) : "‚Äî";
      const sub = t.album || (t.release_year ? String(t.release_year) : "‚Äî");
      return `
        <div class="row item" data-kind="track" data-id="${esc(t.id)}" data-context="${esc(contextKey)}">
          <div class="num">${idx+1}</div>
          <div class="cellTitle">
            <div class="t">${esc(t.title)}</div>
            <div class="s">${esc(sub)}</div>
          </div>
          <div class="tSub" style="margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${esc(t.artist)}</div>
          <div class="dur">${dur}</div>
        </div>
      `;
    }

    function listItemHTML({kind, key, title, subtitle, art_url}){
      const art = `<img src="${esc(artOrFallback(art_url))}" alt="">`;
      return `
        <div class="listItem" data-kind="${esc(kind)}" data-key="${esc(key)}">
          <div class="thumb">${art}</div>
          <div class="liMeta">
            <div class="liT">${esc(title)}</div>
            <div class="liS">${esc(subtitle || "‚Äî")}</div>
          </div>
        </div>
      `;
    }

    function buildDerivedIndexes(){
      state.tracksByAlbumKey = new Map();
      state.tracksByArtistKey = new Map();

      for (const t of state.tracks){
        if (!state.tracksByAlbumKey.has(t.album_key)) state.tracksByAlbumKey.set(t.album_key, []);
        state.tracksByAlbumKey.get(t.album_key).push(t);

        if (!state.tracksByArtistKey.has(t.artist_key)) state.tracksByArtistKey.set(t.artist_key, []);
        state.tracksByArtistKey.get(t.artist_key).push(t);
      }

      for (const [k, arr] of state.tracksByAlbumKey.entries()){
        arr.sort((a,b)=>{
          const an = Number.isFinite(a.track_number) ? a.track_number : 1e9;
          const bn = Number.isFinite(b.track_number) ? b.track_number : 1e9;
          if (an !== bn) return an - bn;
          return (a.title||"").localeCompare(b.title||"");
        });
      }

      for (const [k, arr] of state.tracksByArtistKey.entries()){
        arr.sort((a,b)=>{
          const al = (a.album||"").toLowerCase();
          const bl = (b.album||"").toLowerCase();
          if (al !== bl) return al.localeCompare(bl);
          const an = Number.isFinite(a.track_number) ? a.track_number : 1e9;
          const bn = Number.isFinite(b.track_number) ? b.track_number : 1e9;
          if (an !== bn) return an - bn;
          return (a.title||"").localeCompare(b.title||"");
        });
      }

      state.albums = [];
      for (const [albumKey, arr] of state.tracksByAlbumKey.entries()){
        const first = arr[0];
        const year = arr.map(x=>x.release_year).find(Boolean) || null;
        const art = arr.map(x=>x.art_url).find(Boolean) || "";
        state.albums.push({
          key: albumKey,
          name: first.album,
          artist: first.artist,
          art_url: art,
          year,
          trackCount: arr.length
        });
      }
      state.albums.sort((a,b)=>{
        const aa = (a.artist||"").toLowerCase();
        const ba = (b.artist||"").toLowerCase();
        if (aa !== ba) return aa.localeCompare(ba);
        return (a.name||"").toLowerCase().localeCompare((b.name||"").toLowerCase());
      });

      state.artists = [];
      for (const [artistKey, arr] of state.tracksByArtistKey.entries()){
        const first = arr[0];
        const art = arr.map(x=>x.art_url).find(Boolean) || "";
        state.artists.push({
          key: artistKey,
          name: first.artist,
          art_url: art,
          trackCount: arr.length
        });
      }
      state.artists.sort((a,b)=> (a.name||"").localeCompare(b.name||""));
    }

    function renderSidebarPlaylists(){
      if (!els.playlistList) return;
      const playlists = [
        { name: "Liked Songs", sub: `${state.tracks.length} tracks` },
        { name: "Daily Mix 1", sub: "Auto-generated" },
        { name: "Recently Played", sub: "Auto-generated" },
        { name: "Currents Radio", sub: "Auto-generated" },
      ];
      els.plCount.textContent = playlists.length;
      els.playlistList.innerHTML = playlists.map(p=>`
        <div class="libItem" role="button">
          <div class="dot"></div>
          <div class="meta">
            <div class="title">${esc(p.name)}</div>
            <div class="sub">${esc(p.sub)}</div>
          </div>
        </div>
      `).join("");
    }

    function renderHome(){
      const recent = state.tracks.slice(-10).reverse();
      els.recentHint.textContent = `${state.tracks.length} track${state.tracks.length===1?"":"s"} total`;
      els.recentGrid.innerHTML = recent.map(t => cardHTML({
        kind: "track",
        key: t.id,
        title: t.title,
        subtitle: [t.artist, t.album].filter(Boolean).join(" ‚Ä¢ ") || "‚Äî",
        art_url: t.art_url,
        playHint: "Play"
      })).join("");

      els.artistHint.textContent = `${state.artists.length} artist${state.artists.length===1?"":"s"}`;
      els.artistGrid.innerHTML = state.artists.slice(0,10).map(a => cardHTML({
        kind:"artist", key:a.key,
        title:a.name,
        subtitle:`${a.trackCount} track${a.trackCount===1?"":"s"}`,
        art_url:a.art_url,
        playHint:"Open"
      })).join("");

      els.albumHint.textContent = `${state.albums.length} album${state.albums.length===1?"":"s"}`;
      els.albumGrid.innerHTML = state.albums.slice(0,10).map(al => cardHTML({
        kind:"album", key:al.key,
        title: al.name,
        subtitle: [al.artist, al.year].filter(Boolean).join(" ‚Ä¢ ") || "‚Äî",
        art_url: al.art_url,
        playHint:"Open"
      })).join("");
    }

    function renderLibrary(){
      const sorted = [...state.tracks].sort((a,b)=>{
        const aa = (a.artist||"").toLowerCase();
        const ba = (b.artist||"").toLowerCase();
        if (aa !== ba) return aa.localeCompare(ba);
        const al = (a.album||"").toLowerCase();
        const bl = (b.album||"").toLowerCase();
        if (al !== bl) return al.localeCompare(bl);
        const an = Number.isFinite(a.track_number) ? a.track_number : 1e9;
        const bn = Number.isFinite(b.track_number) ? b.track_number : 1e9;
        if (an !== bn) return an - bn;
        return (a.title||"").localeCompare(b.title||"");
      });
      els.libRows.innerHTML = sorted.map((t,i)=> trackRowHTML(t,i,"library")).join("");

      els.libraryAlbumList.innerHTML = state.albums.map(al => listItemHTML({
        kind:"album",
        key: al.key,
        title: al.name,
        subtitle: `${al.artist} ‚Ä¢ ${al.trackCount} track${al.trackCount===1?"":"s"}`,
        art_url: al.art_url
      })).join("");

      els.libraryArtistList.innerHTML = state.artists.map(a => listItemHTML({
        kind:"artist",
        key: a.key,
        title: a.name,
        subtitle: `${a.trackCount} track${a.trackCount===1?"":"s"}`,
        art_url: a.art_url
      })).join("");

      els.libHint.textContent = `${state.albums.length} albums ‚Ä¢ ${state.artists.length} artists ‚Ä¢ ${state.tracks.length} tracks`;
    }

    function renderQueue(){
      const q = state.queue;
      els.queueRows.innerHTML = q.map((t,i)=> trackRowHTML(t,i,"queue")).join("");
      renderSheetQueue();
      if (state.queueIndex >= 0 && q[state.queueIndex]){
        els.queueHint.textContent = `Now: ${q[state.queueIndex].title} ‚Äî ${q[state.queueIndex].artist}`;
      } else {
        els.queueHint.textContent = "Queue is empty";
      }
    }

    function renderSheetQueue(){
      const q = state.queue || [];
      if (!els.sheetQueueList) return;
      if (!q.length){
        els.sheetQueueList.innerHTML = `
          <div class="qRow">
            <div class="qNum">‚Äî</div>
            <div class="qMeta">
              <div class="qt">Queue is empty</div>
              <div class="qs">Play something to build a queue</div>
            </div>
            <div class="qKick">‚Ä¶</div>
          </div>
        `;
        return;
      }
      els.sheetQueueList.innerHTML = q.map((t,i)=>{
        const isNow = i === state.queueIndex;
        return `
          <div class="qRow ${isNow ? "now":""}" data-qi="${i}">
            <div class="qNum">${i+1}</div>
            <div class="qMeta">
              <div class="qt">${esc(t.title)}</div>
              <div class="qs">${esc(t.artist)} ‚Ä¢ ${esc(t.album)}</div>
            </div>
            <div class="qKick">${isNow ? "‚ñ∂" : "‚ãØ"}</div>
          </div>
        `;
      }).join("");
    }

    function renderChips(){
      document.getElementById("chipRow").innerHTML = CATEGORY_CHIPS.map(c => `
        <button class="chip ${c.label === state.activeChip ? "active" : ""}" data-chip="${esc(c.label)}" data-q="${esc(c.q)}">
          ${esc(c.label)}
        </button>
      `).join("");
    }

    // ===== SEARCH RECENTS =====
    function getRecentSearches(){
      try{
        const raw = localStorage.getItem(SEARCH_RECENTS_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch{ return []; }
    }
    function setRecentSearches(arr){
      try{ localStorage.setItem(SEARCH_RECENTS_KEY, JSON.stringify(arr.slice(0, MAX_RECENTS))); }catch{}
    }
    function pushRecentSearch(q){
      const query = (q||"").trim();
      if (!query) return;
      const rec = getRecentSearches().filter(x => String(x).toLowerCase() !== query.toLowerCase());
      rec.unshift(query);
      setRecentSearches(rec);
      renderRecentSearches();
    }
    function removeRecentSearch(q){
      const rec = getRecentSearches().filter(x => x !== q);
      setRecentSearches(rec);
      renderRecentSearches();
    }
    function clearRecentSearches(){
      setRecentSearches([]);
      renderRecentSearches();
    }
    function renderRecentSearches(){
      const rec = getRecentSearches();
      if (!rec.length){
        els.recentSearches.innerHTML = `
          <div class="recentRow">
            <div class="q" style="color:rgba(255,255,255,.75);font-weight:900;">No recent searches</div>
            <div class="hint">‚Äî</div>
          </div>
        `;
        return;
      }
      els.recentSearches.innerHTML = rec.map(q => `
        <div class="recentRow" data-q="${esc(q)}">
          <div class="q">${esc(q)}</div>
          <button class="x" title="Remove" data-action="remove" data-q="${esc(q)}">‚úï</button>
        </div>
      `).join("");
    }

    // ===== SEARCH ENGINE =====
    function searchEngine(query, chipQ){
      const q = (query||"").trim().toLowerCase();

      if (chipQ === "__recent__") return state.tracks.slice(-24).reverse();
      if (chipQ === "__singles__") return state.tracks.filter(t => (t.album||"").toLowerCase().includes("single"));

      let tracks = [...state.tracks];

      if (q){
        tracks = tracks.filter(t => (
          [t.title, t.artist, t.album, t.release_year].some(v => String(v||"").toLowerCase().includes(q))
        ));
      }

      if (chipQ && !["__artists__","__albums__","__recent__","__singles__"].includes(chipQ)){
        const cq = String(chipQ).toLowerCase();
        tracks = tracks.filter(t => (
          [t.title, t.artist, t.album, t.release_year].some(v => String(v||"").toLowerCase().includes(cq))
        ));
      }

      return tracks;
    }

    function renderSearchView(q, chipQ){
      const query = (q||"").trim().toLowerCase();

      const tracks = searchEngine(query, chipQ);
      state.filteredTracks = tracks;

      const matchedArtists = query
        ? state.artists.filter(a => a.name.toLowerCase().includes(query)).slice(0,6)
        : state.artists.slice(0,6);

      const matchedAlbums = query
        ? state.albums.filter(a => (a.name+" "+a.artist).toLowerCase().includes(query)).slice(0,6)
        : state.albums.slice(0,6);

      const topTracks = tracks.slice(0,10);
      const cards = [];

      if (chipQ === "__artists__"){
        cards.push(...state.artists.slice(0,12).map(a => cardHTML({
          kind:"artist", key:a.key,
          title:a.name,
          subtitle:`${a.trackCount} tracks`,
          art_url:a.art_url,
          playHint:"Open"
        })));
      } else if (chipQ === "__albums__"){
        cards.push(...state.albums.slice(0,12).map(al => cardHTML({
          kind:"album", key:al.key,
          title:al.name,
          subtitle:[al.artist, al.year].filter(Boolean).join(" ‚Ä¢ ") || "‚Äî",
          art_url:al.art_url,
          playHint:"Open"
        })));
      } else {
        cards.push(...matchedArtists.map(a => cardHTML({
          kind:"artist", key:a.key,
          title:a.name,
          subtitle:`${a.trackCount} tracks`,
          art_url:a.art_url,
          playHint:"Open"
        })));
        cards.push(...matchedAlbums.map(al => cardHTML({
          kind:"album", key:al.key,
          title:al.name,
          subtitle:[al.artist, al.year].filter(Boolean).join(" ‚Ä¢ ") || "‚Äî",
          art_url:al.art_url,
          playHint:"Open"
        })));
        cards.push(...topTracks.map(t => cardHTML({
          kind:"track", key:t.id,
          title:t.title,
          subtitle:[t.artist,t.album].filter(Boolean).join(" ‚Ä¢ "),
          art_url:t.art_url,
          playHint:"Play"
        })));
      }

      els.searchGrid.innerHTML = cards.join("");
      els.searchRows.innerHTML = tracks.slice(0,50).map((t,i)=> trackRowHTML(t,i,"search")).join("");
      els.searchCountHint.textContent = `${tracks.length} track result${tracks.length===1?"":"s"}`;
    }

    // ===== DETAIL PAGES =====
    function openAlbum(albumKey){
      state.activeAlbumKey = albumKey;
      const tracks = state.tracksByAlbumKey.get(albumKey) || [];
      if (!tracks.length){ toast("Album not found."); return; }
      const first = tracks[0];
      const art = tracks.map(t=>t.art_url).find(Boolean) || "";
      els.albumTitle.textContent = first.album;
      els.albumSub.textContent = [first.artist, tracks.map(t=>t.release_year).find(Boolean), `${tracks.length} tracks`].filter(Boolean).join(" ‚Ä¢ ");
      if (art) { els.albumArt.src = art; els.albumArt.style.display="block"; } else { els.albumArt.removeAttribute("src"); els.albumArt.style.display="none"; }
      els.albumRows.innerHTML = tracks.map((t,i)=> trackRowHTML(t,i,albumKey)).join("");
      routeTo("album");
      location.hash = "#album";
    }

    function openArtist(artistKey){
      state.activeArtistKey = artistKey;
      const tracks = state.tracksByArtistKey.get(artistKey) || [];
      if (!tracks.length){ toast("Artist not found."); return; }
      const first = tracks[0];
      const art = tracks.map(t=>t.art_url).find(Boolean) || "";
      els.artistTitle.textContent = first.artist;
      els.artistSub.textContent = `${tracks.length} tracks`;
      if (art) { els.artistArt.src = art; els.artistArt.style.display="block"; } else { els.artistArt.removeAttribute("src"); els.artistArt.style.display="none"; }

      const albums = state.albums.filter(a => `artist:${slug(a.artist)}` === artistKey);
      els.artistAlbumHint.textContent = `${albums.length} album${albums.length===1?"":"s"}`;
      els.artistAlbumGrid.innerHTML = albums.map(al => cardHTML({
        kind:"album", key:al.key, title:al.name,
        subtitle: [al.artist, al.year].filter(Boolean).join(" ‚Ä¢ ") || "‚Äî",
        art_url: al.art_url, playHint:"Open"
      })).join("");

      els.artistRows.innerHTML = tracks.slice(0,50).map((t,i)=> trackRowHTML(t,i,artistKey)).join("");
      routeTo("artist");
      location.hash = "#artist";
    }

    // ===== ROUTING =====
    function routeTo(route){
      for (const k of Object.keys(els.views)){
        els.views[k].style.display = (k === route) ? "block" : "none";
      }
      if (els.nav){
        [...els.nav.querySelectorAll("a")].forEach(a => a.classList.toggle("active", a.dataset.route === route));
      }
      els.mTabs.forEach(b => b.classList.toggle("active", b.dataset.route === route));
    }

    function getRouteFromHash(){
      const h = (location.hash || "#home").replace("#","");
      if (["home","search","library","queue","album","artist"].includes(h)) return h;
      return "home";
    }

    // ===== QUEUE / PLAYBACK =====
    function setQueue(list, startIndex=0){
      state.queue = [...list];
      state.queueIndex = Math.max(0, Math.min(startIndex, state.queue.length-1));
      state.playedHistory = [];
      renderQueue();
    }

    function currentTrack(){
      if (state.queueIndex < 0) return null;
      return state.queue[state.queueIndex] || null;
    }

    function syncNowPlayingUI(){
      const t = currentTrack();

      const title = t ? (t.title || "Untitled") : "Nothing playing";
      const sub   = t ? [t.artist, t.album].filter(Boolean).join(" ‚Ä¢ ") : "‚Äî";
      const art   = t ? artOrFallback(t.art_url) : FALLBACK_ART;

      // desktop footer
      if (els.nowTitle) els.nowTitle.textContent = title;
      if (els.nowSub) els.nowSub.textContent = sub;
      if (els.nowArt){
        els.nowArt.src = artOrFallback(art);
        els.nowArt.style.display = "block";
      }

      // mini player
      els.miniTitle.textContent = title;
      els.miniSub.textContent = sub;
      els.miniArt.src = artOrFallback(art);
      els.miniArt.style.display="block";

      // sheet
      els.npTitle.textContent = title;
      els.npSub.textContent = sub;
      els.npArt.src = artOrFallback(art);
      els.npArt.style.display="block";

      // lyrics
      const lyr = t && t.lyrics ? String(t.lyrics) : "No lyrics found for this track.";
      els.lyricsText.textContent = lyr;

      // likes
      if (t) setFavUI(t.id);

      renderQueue();
      syncModeUI();
    }

    function setPlayIcon(isPlaying) {
      const icon = document.getElementById("iconPlay");
      icon.innerHTML = isPlaying
        ? '<path d="M6 5h4v14H6zm8 0h4v14h-4z"/>'
        : '<path d="M8 5v14l11-7z"/>';
    }

    audio.addEventListener("play", () => setPlayIcon(true));
    audio.addEventListener("pause", () => setPlayIcon(false));
    
    let repeatMode = "off"; // off | all | one

    btnRepeat.addEventListener("click", () => {
      repeatMode =
        repeatMode === "off" ? "all" :
        repeatMode === "all" ? "one" :
        "off";

      btnRepeat.classList.toggle("active", repeatMode !== "off");
    });


    function playAt(index){
      const t = state.queue[index];
      if (!t){ return; }
      if (!t.stream_url){ toast("Missing stream_url for this track."); return; }

      // history for shuffle back behavior
      if (state.queueIndex >= 0 && state.queueIndex !== index){
        state.playedHistory.push(state.queueIndex);
        state.playedHistory = state.playedHistory.slice(-50);
      }

      state.queueIndex = index;

      syncNowPlayingUI();

      els.audio.src = t.stream_url;
      els.audio.play().then(()=>{
        setPlayIcons(true);
      }).catch((err)=>{
        console.error(err);
        setPlayIcons(false);
        toast("Playback failed (check CloudFront URL + range/CORS).");
      });

      renderQueue();
    }

    function ensureQueue(){
      if (!state.queue.length && state.tracks.length){
        setQueue(state.tracks, 0);
      }
    }

    function togglePlay(){
      ensureQueue();

      if (!els.audio.src){
        if (state.queue.length){
          playAt(Math.max(0, state.queueIndex));
        }
        return;
      }

      if (els.audio.paused){
        els.audio.play().then(()=> setPlayIcons(true)).catch(()=> toast("Playback failed."));
      } else {
        els.audio.pause();
        setPlayIcons(false);
      }
    }
    function setPlayIcons(isPlaying){
      // Desktop (footer player)
      const dp = document.getElementById("iconPlay");
      if (dp){
        dp.innerHTML = isPlaying
          ? '<path d="M6 5h4v14H6zM14 5h4v14h-4z"/>'
          : '<path d="M8 5v14l11-7z"/>';
      }

      // Mobile: mini player
      const mp = document.getElementById("miniIconPlay");
      if (mp){
        mp.innerHTML = isPlaying
          ? '<path d="M6 5h4v14H6zM14 5h4v14h-4z"/>'
          : '<path d="M8 5v14l11-7z"/>';
      }

      // Mobile: now playing sheet
      const sp = document.getElementById("npIconPlay");
      if (sp){
        sp.innerHTML = isPlaying
          ? '<path d="M6 5h4v14H6zM14 5h4v14h-4z"/>'
          : '<path d="M8 5v14l11-7z"/>';
      }
    }


    function pickNextIndex(){
      if (!state.queue.length) return -1;

      // repeat-one: stay
      if (state.repeat === "one") return state.queueIndex;

      // shuffle: choose random, avoid current when possible
      if (state.shuffle){
        if (state.queue.length === 1) return 0;
        let tries = 0;
        let idx = state.queueIndex;
        while (idx === state.queueIndex && tries < 10){
          idx = Math.floor(Math.random() * state.queue.length);
          tries++;
        }
        return idx;
      }

      // normal sequential
      const nextIndex = state.queueIndex + 1;

      if (nextIndex < state.queue.length) return nextIndex;

      // end: repeat-all loops, otherwise stop
      if (state.repeat === "all") return 0;
      return -1;
    }

    function next(){
      if (!state.queue.length) return;
      const ni = pickNextIndex();
      if (ni === -1){
        // stop at end
        els.audio.pause();
        setPlayIcons(false);
        toast("End of queue");
        return;
      }
      playAt(ni);
    }

    function prev(){
      if (!state.queue.length) return;

      // if within first 3s, go previous; else restart
      const cur = els.audio.currentTime || 0;
      if (cur > 3){
        els.audio.currentTime = 0;
        return;
      }

      // shuffle: go back in history if available
      if (state.shuffle && state.playedHistory.length){
        const last = state.playedHistory.pop();
        if (typeof last === "number" && last >= 0) {
          playAt(last);
          return;
        }
      }

      const prevIndex = (state.queueIndex - 1 + state.queue.length) % state.queue.length;
      playAt(prevIndex);
    }

    function enqueueNext(track){
      ensureQueue();
      if (!state.queue.length){
        setQueue([track], 0);
        playAt(0);
        return;
      }
      const insertAt = Math.min(state.queueIndex + 1, state.queue.length);
      state.queue.splice(insertAt, 0, track);
      toast("Queued next");
      renderQueue();
    }

    function addToQueue(track){
      ensureQueue();
      state.queue.push(track);
      toast("Added to queue");
      renderQueue();
    }

    function playFromContext(trackId, contextKey){
      const track = state.tracks.find(t=>t.id === trackId);
      if (!track) return;

      let list = null;
      if (contextKey.startsWith("album:")){
        list = state.tracksByAlbumKey.get(contextKey) || null;
      } else if (contextKey.startsWith("artist:")){
        list = state.tracksByArtistKey.get(contextKey) || null;
      } else if (contextKey === "search"){
        list = state.filteredTracks || null;
      } else if (contextKey === "library"){
        list = [...state.tracks].sort((a,b)=>{
          const aa=(a.artist||"").toLowerCase(), ba=(b.artist||"").toLowerCase();
          if (aa!==ba) return aa.localeCompare(ba);
          const al=(a.album||"").toLowerCase(), bl=(b.album||"").toLowerCase();
          if (al!==bl) return al.localeCompare(bl);
          const an=Number.isFinite(a.track_number)?a.track_number:1e9;
          const bn=Number.isFinite(b.track_number)?b.track_number:1e9;
          if (an!==bn) return an-bn;
          return (a.title||"").localeCompare(b.title||"");
        });
      } else {
        list = state.tracks;
      }

      if (!list || !list.length) list = state.tracks;

      const startIndex = list.findIndex(x => x.id === trackId);
      setQueue(list, startIndex >= 0 ? startIndex : 0);
      playAt(state.queueIndex);
    }

    // ===== MINI PLAYER + SHEET =====
    function openSheet(){
      state.sheetOpen = true;
      els.sheetWrap.classList.add("show");
      els.sheetWrap.setAttribute("aria-hidden","false");
      els.sheet.style.transition = "transform .22s ease";
      els.sheet.style.transform = "translateY(0)";
      setTimeout(()=> { els.sheet.style.transition = ""; }, 260);
    }

    function closeSheet(){
      state.sheetOpen = false;
      els.sheet.style.transition = "transform .18s ease";
      els.sheet.style.transform = "translateY(102%)";
      setTimeout(()=>{
        els.sheetWrap.classList.remove("show");
        els.sheetWrap.setAttribute("aria-hidden","true");
        els.sheet.style.transition = "";
        els.sheet.style.transform = "";
      }, 190);
    }

    function sheetDragStart(y){
      state.sheetDrag.active = true;
      state.sheetDrag.startY = y;
      state.sheetDrag.curY = y;
      els.sheet.style.transition = "none";
    }
    function sheetDragMove(y){
      if (!state.sheetDrag.active) return;
      state.sheetDrag.curY = y;
      const dy = Math.max(0, y - state.sheetDrag.startY);
      els.sheet.style.transform = `translateY(${dy}px)`;
    }
    function sheetDragEnd(){
      if (!state.sheetDrag.active) return;
      state.sheetDrag.active = false;
      const dy = Math.max(0, state.sheetDrag.curY - state.sheetDrag.startY);
      const threshold = Math.min(180, window.innerHeight * 0.18);
      els.sheet.style.transition = "transform .18s ease";
      if (dy > threshold){
        closeSheet();
      } else {
        els.sheet.style.transform = "translateY(0)";
        setTimeout(()=> { els.sheet.style.transition = ""; }, 200);
      }
    }

    function setSheetTab(name){
      const tabs = [
        ["Now", els.sheetTabNow, els.sheetViewNow],
        ["Queue", els.sheetTabQueue, els.sheetViewQueue],
        ["Lyrics", els.sheetTabLyrics, els.sheetViewLyrics],
      ];
      tabs.forEach(([n, btn, view])=>{
        const on = (n === name);
        btn.classList.toggle("active", on);
        view.style.display = on ? "block" : "none";
      });
    }

    // ===== EVENTS =====
    function wireNav(){
      window.addEventListener("hashchange", ()=>{
        const r = getRouteFromHash();

        if (["home","search","library","queue"].includes(r)){
          state.lastNonDetailRoute = r;
        }

        routeTo(r);

        if (r === "search"){
          renderChips();
          renderRecentSearches();
          renderSearchView(els.searchInput.value, CATEGORY_CHIPS.find(c=>c.label===state.activeChip)?.q || "");
        }
        if (r === "library") renderLibrary();
        if (r === "queue") renderQueue();
        if (r === "home") renderHome();
      });

      if (els.nav){
        els.nav.addEventListener("click", (e)=>{
          const a = e.target.closest("a[data-route]");
          if (!a) return;
          const r = a.dataset.route;
          state.lastNonDetailRoute = r;
          location.hash = `#${r}`;
          routeTo(r);
        });
      }

      els.mTabs.forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const r = btn.dataset.route;
          state.lastNonDetailRoute = r;
          location.hash = `#${r}`;
          routeTo(r);

          if (r === "search"){
            setTimeout(()=> els.searchInput.focus(), 50);
          }
        });
      });
    }

    function wireSearch(){
      els.searchInput.addEventListener("input", (e)=>{
        const q = e.target.value;
        if (getRouteFromHash() !== "search") location.hash = "#search";
        renderSearchView(q, CATEGORY_CHIPS.find(c=>c.label===state.activeChip)?.q || "");
      });

      els.searchInput.addEventListener("keydown", (e)=>{
        if (e.key === "Enter"){
          pushRecentSearch(els.searchInput.value);
        }
      });

      els.clearRecentBtn.addEventListener("click", ()=>{
        clearRecentSearches();
        toast("Cleared recent searches");
      });

      els.recentSearches.addEventListener("click", (e)=>{
        const rm = e.target.closest('button[data-action="remove"]');
        if (rm){
          removeRecentSearch(rm.dataset.q);
          return;
        }
        const row = e.target.closest(".recentRow");
        if (!row) return;
        const q = row.dataset.q || "";
        els.searchInput.value = q;
        pushRecentSearch(q);
        renderSearchView(q, CATEGORY_CHIPS.find(c=>c.label===state.activeChip)?.q || "");
      });

      els.chipRow.addEventListener("click", (e)=>{
        const chip = e.target.closest(".chip");
        if (!chip) return;
        const label = chip.dataset.chip;
        state.activeChip = label;
        renderChips();
        renderSearchView(els.searchInput.value, chip.dataset.q || "");
      });
    }

    function wireLibraryTabs(){
      els.tabAlbums.addEventListener("click", ()=>{
        els.tabAlbums.classList.add("active");
        els.tabArtists.classList.remove("active");
        els.libraryAlbums.style.display = "block";
        els.libraryArtists.style.display = "none";
      });
      els.tabArtists.addEventListener("click", ()=>{
        els.tabArtists.classList.add("active");
        els.tabAlbums.classList.remove("active");
        els.libraryArtists.style.display = "block";
        els.libraryAlbums.style.display = "none";
      });
    }

    function wirePlayer(){
      // desktop
      if (els.playBtn) els.playBtn.addEventListener("click", togglePlay);
      if (els.prevBtn) els.prevBtn.addEventListener("click", prev);
      if (els.nextBtn) els.nextBtn.addEventListener("click", next);

      if (els.shuffleBtn) els.shuffleBtn.addEventListener("click", toggleShuffle);
      if (els.repeatBtn)  els.repeatBtn.addEventListener("click", cycleRepeat);

      // desktop volume
      if (els.vol){
        els.vol.addEventListener("input", ()=> {
          els.audio.volume = Number(els.vol.value);
          els.npVol.value = String(els.audio.volume);
          els.npVolHint.textContent = Math.round(els.audio.volume*100) + "%";
        });
        els.audio.volume = Number(els.vol.value);
      }

      // sheet volume
      els.npVol.addEventListener("input", ()=>{
        els.audio.volume = Number(els.npVol.value);
        if (els.vol) els.vol.value = String(els.audio.volume);
        els.npVolHint.textContent = Math.round(els.audio.volume*100) + "%";
      });
      els.npVol.value = String(els.audio.volume);
      els.npVolHint.textContent = Math.round(els.audio.volume*100) + "%";

      // desktop timeline
      if (els.seek){
        els.seek.addEventListener("input", ()=> state.isSeekingDesktop = true);
        els.seek.addEventListener("change", ()=>{
          const dur = els.audio.duration || 0;
          if (dur){
            const pct = Number(els.seek.value)/100;
            els.audio.currentTime = dur * pct;
          }
          state.isSeekingDesktop = false;
        });
      }

      // sheet timeline
      els.npSeek.addEventListener("input", ()=> state.isSeekingSheet = true);
      els.npSeek.addEventListener("change", ()=>{
        const dur = els.audio.duration || 0;
        if (dur){
          const pct = Number(els.npSeek.value)/100;
          els.audio.currentTime = dur * pct;
        }
        state.isSeekingSheet = false;
      });

      // audio updates drive ALL UI
      els.audio.addEventListener("timeupdate", ()=>{
        const cur = els.audio.currentTime || 0;
        const dur = els.audio.duration || 0;

        // desktop
        if (els.curTime) els.curTime.textContent = fmtTime(cur);
        if (els.durTime) els.durTime.textContent = fmtTime(dur);
        if (els.seek && !state.isSeekingDesktop) els.seek.value = dur ? Math.round((cur/dur)*100) : 0;

        // sheet
        els.npCur.textContent = fmtTime(cur);
        els.npDur.textContent = fmtTime(dur);
        if (!state.isSeekingSheet) els.npSeek.value = dur ? Math.round((cur/dur)*100) : 0;

        // mini progress
        const pct = dur ? (cur/dur)*100 : 0;
        els.miniProgFill.style.width = pct + "%";
      });

      els.audio.addEventListener("play", ()=> setPlayIcons(true));
      els.audio.addEventListener("pause", ()=> setPlayIcons(false));

      // ended behavior respects repeat/shuffle
      els.audio.addEventListener("ended", ()=>{
        if (state.repeat === "one"){
          els.audio.currentTime = 0;
          els.audio.play().catch(()=>{});
          return;
        }
        next();
      });

      // keyboard shortcuts (desktop)
      window.addEventListener("keydown", (e)=>{
        const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
        if (tag === "input" || tag === "textarea") return;

        if (e.code === "Space"){
          e.preventDefault();
          togglePlay();
        } else if (e.key === "n" || e.key === "N"){
          next();
        } else if (e.key === "p" || e.key === "P"){
          prev();
        } else if (e.key === "ArrowRight"){
          els.audio.currentTime = Math.min((els.audio.currentTime||0) + 10, els.audio.duration || 1e9);
        } else if (e.key === "ArrowLeft"){
          els.audio.currentTime = Math.max((els.audio.currentTime||0) - 10, 0);
        } else if (e.key === "ArrowUp"){
          e.preventDefault();
          const v = Math.min(1, els.audio.volume + 0.05);
          els.audio.volume = v;
          if (els.vol) els.vol.value = String(v);
          els.npVol.value = String(v);
          els.npVolHint.textContent = Math.round(v*100) + "%";
        } else if (e.key === "ArrowDown"){
          e.preventDefault();
          const v = Math.max(0, els.audio.volume - 0.05);
          els.audio.volume = v;
          if (els.vol) els.vol.value = String(v);
          els.npVol.value = String(v);
          els.npVolHint.textContent = Math.round(v*100) + "%";
        } else if (e.key === "s" || e.key === "S"){
          toggleShuffle();
        } else if (e.key === "r" || e.key === "R"){
          cycleRepeat();
        }
      });

      // mini player controls
      els.miniPlayBtn.addEventListener("click", (e)=>{ e.stopPropagation(); togglePlay(); });
      els.miniNextBtn.addEventListener("click", (e)=>{ e.stopPropagation(); next(); });
      els.miniShuffleBtn.addEventListener("click", (e)=>{ e.stopPropagation(); toggleShuffle(); });
      els.miniRepeatBtn.addEventListener("click", (e)=>{ e.stopPropagation(); cycleRepeat(); });

      // tap mini player to open sheet
      els.miniPlayer.addEventListener("click", ()=>{
        if (!isMobile()) return;
        openSheet();
      });

      // sheet controls
      els.sheetBackdrop.addEventListener("click", closeSheet);
      els.sheetCloseBtn.addEventListener("click", closeSheet);

      els.npPlayBtn.addEventListener("click", togglePlay);
      els.npPrevBtn.addEventListener("click", prev);
      els.npNextBtn.addEventListener("click", next);
      els.npShuffleBtn.addEventListener("click", toggleShuffle);
      els.npRepeatBtn.addEventListener("click", cycleRepeat);

      // sheet queue button jumps to Queue tab (inside sheet)
      els.sheetQueueBtn.addEventListener("click", ()=>{
        setSheetTab("Queue");
      });

      // sheet tabs
      els.sheetTabNow.addEventListener("click", ()=> setSheetTab("Now"));
      els.sheetTabQueue.addEventListener("click", ()=> setSheetTab("Queue"));
      els.sheetTabLyrics.addEventListener("click", ()=> setSheetTab("Lyrics"));

      // queue click inside sheet
      els.sheetQueueList.addEventListener("click", (e)=>{
        const row = e.target.closest(".qRow");
        if (!row) return;
        const i = Number(row.dataset.qi);
        if (Number.isFinite(i)) playAt(i);
      });

      els.npFavBtn.addEventListener("click", ()=>{
        const t = currentTrack();
        if (!t) return;
        if (state.likes.has(t.id)) state.likes.delete(t.id);
        else state.likes.add(t.id);
        persistLikes();
        setFavUI(t.id);
        toast(state.likes.has(t.id) ? "Liked" : "Unliked");
      });

      // swipe / drag down to close (touch + mouse)
      const start = (clientY)=> sheetDragStart(clientY);
      const move  = (clientY)=> sheetDragMove(clientY);
      const end   = ()=> sheetDragEnd();

      els.sheet.addEventListener("touchstart", (e)=>{
        if (!state.sheetOpen) return;
        const y = e.touches[0].clientY;
        start(y);
      }, {passive:true});

      els.sheet.addEventListener("touchmove", (e)=>{
        if (!state.sheetDrag.active) return;
        const y = e.touches[0].clientY;
        move(y);
      }, {passive:true});

      els.sheet.addEventListener("touchend", end, {passive:true});

      // mouse drag for desktop testing
      els.sheet.addEventListener("mousedown", (e)=>{
        if (!state.sheetOpen) return;
        start(e.clientY);
        const mm = (ev)=> move(ev.clientY);
        const mu = ()=>{
          window.removeEventListener("mousemove", mm);
          window.removeEventListener("mouseup", mu);
          end();
        };
        window.addEventListener("mousemove", mm);
        window.addEventListener("mouseup", mu);
      });
    }

    function wireClicks(){
      document.body.addEventListener("click", (e)=>{
        const card = e.target.closest(".card");
        const row  = e.target.closest(".row.item");
        const li   = e.target.closest(".listItem");

        if (card){
          const kind = card.dataset.kind;
          const key  = card.dataset.key;

          const currentRoute = getRouteFromHash();
          if (["home","search","library","queue"].includes(currentRoute)){
            state.lastNonDetailRoute = currentRoute;
          }

          if (kind === "track"){
            playFromContext(key, currentRoute === "search" ? "search" : "home");
            return;
          }
          if (kind === "album"){ openAlbum(key); return; }
          if (kind === "artist"){ openArtist(key); return; }
        }

        if (li){
          const kind = li.dataset.kind;
          const key = li.dataset.key;
          if (kind === "album") openAlbum(key);
          if (kind === "artist") openArtist(key);
          return;
        }

        if (row){
          const trackId = row.dataset.id;
          const context = row.dataset.context || "library";
          const track = state.tracks.find(t=>t.id === trackId);
          if (!track) return;

          if (e.shiftKey){
            enqueueNext(track);
          } else if (e.ctrlKey || e.metaKey){
            addToQueue(track);
          } else {
            playFromContext(trackId, context);
          }
        }
      });

      els.albumPlayBtn.addEventListener("click", ()=>{
        const k = state.activeAlbumKey;
        const list = state.tracksByAlbumKey.get(k) || [];
        if (!list.length) return;
        setQueue(list, 0);
        playAt(0);
      });
      els.albumBackBtn.addEventListener("click", ()=>{
        const back = state.lastNonDetailRoute || "home";
        location.hash = `#${back}`;
        routeTo(back);
        if (back === "search"){
          renderChips(); renderRecentSearches();
          renderSearchView(els.searchInput.value, CATEGORY_CHIPS.find(c=>c.label===state.activeChip)?.q || "");
        }
        if (back === "library") renderLibrary();
        if (back === "queue") renderQueue();
        if (back === "home") renderHome();
      });

      els.artistPlayBtn.addEventListener("click", ()=>{
        const k = state.activeArtistKey;
        const list = state.tracksByArtistKey.get(k) || [];
        if (!list.length) return;
        setQueue(list, 0);
        playAt(0);
      });
      els.artistBackBtn.addEventListener("click", ()=>{
        const back = state.lastNonDetailRoute || "home";
        location.hash = `#${back}`;
        routeTo(back);
        if (back === "search"){
          renderChips(); renderRecentSearches();
          renderSearchView(els.searchInput.value, CATEGORY_CHIPS.find(c=>c.label===state.activeChip)?.q || "");
        }
        if (back === "library") renderLibrary();
        if (back === "queue") renderQueue();
        if (back === "home") renderHome();
      });
    }

    function wireRefresh(){
      els.refreshBtn.addEventListener("click", async ()=>{
        try { await loadTracks(); toast("Refreshed."); }
        catch (err){ console.error(err); toast(err.message); }
      });
    }

    // ===== UPLOAD MODAL =====
    function openUploadModal(){
      if (!isArtist()) { toast("Upload is for Artists/Admins. Ask an admin to grant Artist role."); return; }
els.uploadOverlay.classList.add("show");
      els.uploadOverlay.setAttribute("aria-hidden","false");
      validateUploadForm();
    }
    function closeUploadModal(){
      els.uploadOverlay.classList.remove("show");
      els.uploadOverlay.setAttribute("aria-hidden","true");
    }

    async function validateArtFile(){
      const file = els.fArt.files?.[0];
      if (!file) return { ok: true };
      if (!file.type.startsWith("image/")) return { ok:false, msg:"Album art must be an image." };

      const img = new Image();
      const url = URL.createObjectURL(file);
      try{
        const dims = await new Promise((resolve, reject)=>{
          img.onload = ()=> resolve({w:img.naturalWidth, h:img.naturalHeight});
          img.onerror = reject;
          img.src = url;
        });
        URL.revokeObjectURL(url);
        if (dims.w > 3000 || dims.h > 3000){
          return { ok:false, msg:`Album art too large (${dims.w}√ó${dims.h}). Max 3000√ó3000.` };
        }
        return { ok:true };
      }catch{
        URL.revokeObjectURL(url);
        return { ok:false, msg:"Could not read album art dimensions." };
      }
    }

    async function validateUploadForm(){
      const title = els.fTitle.value.trim();
      const artist = els.fArtist.value.trim();
      const album = els.fAlbum.value.trim();
      const audio = els.fAudio.files?.[0];

      const artCheck = await validateArtFile();
      if (!artCheck.ok){
        els.uploadNote.textContent = artCheck.msg;
        els.uploadSubmitBtn.disabled = true;
        return;
      }

      const ready = Boolean(title && artist && album && audio);
      els.uploadNote.textContent = ready
        ? "Ready to upload."
        : "Fill title/artist/album and choose an audio file (art optional, ‚â§ 3000√ó3000).";
      els.uploadSubmitBtn.disabled = !ready;
    }

    async function uploadViaPresign(){
      const title = els.fTitle.value.trim();
      const artist = els.fArtist.value.trim();
      const album = els.fAlbum.value.trim();
      const trackNo = els.fTrackNo.value ? Number(els.fTrackNo.value) : null;
      const year = els.fYear.value ? Number(els.fYear.value) : null;

      const audioFile = els.fAudio.files?.[0];
      const artFile = els.fArt.files?.[0];

      if (!title || !artist || !album || !audioFile){
        toast("Missing required fields.");
        return;
      }

      els.uploadSubmitBtn.disabled = true;
      els.uploadSubmitBtn.textContent = "Uploading‚Ä¶";

      try{
        toast("Requesting upload URLs‚Ä¶");

        const initRes = await fetch(apiUrl(UPLOADS_INIT_ENDPOINT), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            title,
            artist,
            album,
            track_number: trackNo,
            release_year: year,
            audio_filename: audioFile.name,
            audio_content_type: audioFile.type || "application/octet-stream",
            art_filename: artFile ? artFile.name : null,
            art_content_type: artFile ? (artFile.type || "application/octet-stream") : null,
          }),
        });

        if (!initRes.ok){
          const txt = await initRes.text().catch(()=> "");
          console.error("uploads/init error:", initRes.status, txt);
          throw new Error(`uploads/init failed: ${initRes.status}`);
        }

        const init = await initRes.json();

        if (!init.audio_put_url || !init.audio_key){
          console.error("uploads/init missing audio_put_url/audio_key:", init);
          throw new Error("uploads/init returned invalid payload (missing audio).");
        }

        // 1) META FIRST
        if (init.meta_put_url && init.meta_key){
          toast("Uploading metadata‚Ä¶");
          const meta = {
            title,
            artist,
            album,
            track_number: trackNo,
            release_year: year,
            audio_key: init.audio_key,
            art_key: init.art_key || null,
          };

          const metaPut = await fetch(init.meta_put_url, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(meta),
          });

          if (!metaPut.ok){
            const txt = await metaPut.text().catch(()=> "");
            console.error("meta PUT failed:", metaPut.status, txt);
            throw new Error(`Metadata upload failed: ${metaPut.status}`);
          }
        }

        // 2) ART SECOND (optional)
        if (artFile && init.art_put_url){
          toast("Uploading album art‚Ä¶");
          const putArt = await fetch(init.art_put_url, {
            method: "PUT",
            headers: { "Content-Type": artFile.type || "application/octet-stream" },
            body: artFile
          });
          if (!putArt.ok){
            const txt = await putArt.text().catch(()=> "");
            console.warn("art PUT failed:", putArt.status, txt);
          }
        }

        // 3) AUDIO LAST
        toast("Uploading audio‚Ä¶");
        const putAudio = await fetch(init.audio_put_url, {
          method: "PUT",
          headers: { "Content-Type": audioFile.type || "application/octet-stream" },
          body: audioFile
        });

        if (!putAudio.ok){
          const txt = await putAudio.text().catch(()=> "");
          console.error("audio PUT failed:", putAudio.status, txt);
          throw new Error(`Audio upload failed: ${putAudio.status}`);
        }

        closeUploadModal();
        toast("Upload received. Ingest will process‚Äîhit Refresh in ~10‚Äì30s.");
        setTimeout(()=> { loadTracks().catch(()=>{}); }, 6000);

      } finally {
        els.uploadSubmitBtn.textContent = "Upload";
        await validateUploadForm();
      }
    }

    function wireUploadModal(){
      els.uploadBtn.addEventListener("click", openUploadModal);
      els.uploadCloseBtn.addEventListener("click", closeUploadModal);
      els.uploadCancelBtn.addEventListener("click", closeUploadModal);
      els.uploadOverlay.addEventListener("click", (e)=>{
        if (e.target === els.uploadOverlay) closeUploadModal();
      });

      ["input","change"].forEach(evt=>{
        els.fTitle.addEventListener(evt, validateUploadForm);
        els.fArtist.addEventListener(evt, validateUploadForm);
        els.fAlbum.addEventListener(evt, validateUploadForm);
        els.fTrackNo.addEventListener(evt, validateUploadForm);
        els.fYear.addEventListener(evt, validateUploadForm);
        els.fArt.addEventListener(evt, validateUploadForm);
        els.fAudio.addEventListener(evt, validateUploadForm);
      });

      els.uploadSubmitBtn.addEventListener("click", ()=>{
        uploadViaPresign().catch(err=>{
          console.error(err);
          toast(err.message || "Upload failed (check console).");
          validateUploadForm().catch(()=>{});
        });
      });
    }

    // ===== LOAD =====
    async function loadTracks(){
      toast("Loading tracks‚Ä¶");
      const res = await fetch(apiUrl(TRACKS_ENDPOINT), { method:"GET" });
      if (!res.ok){
        const txt = await res.text().catch(()=> "");
        throw new Error(`GET ${TRACKS_ENDPOINT} failed: ${res.status} ${res.statusText} ${txt}`);
      }

      const data = await res.json();
      if (!Array.isArray(data)){
        throw new Error("Expected /tracks to return an array.");
      }

      const tracks = data.map(normalizeTrack).filter(t => t.id && t.stream_url);

      tracks.sort((a,b)=>{
        const aa=(a.artist||"").toLowerCase(), ba=(b.artist||"").toLowerCase();
        if (aa!==ba) return aa.localeCompare(ba);
        const al=(a.album||"").toLowerCase(), bl=(b.album||"").toLowerCase();
        if (al!==bl) return al.localeCompare(bl);
        const an=Number.isFinite(a.track_number)?a.track_number:1e9;
        const bn=Number.isFinite(b.track_number)?b.track_number:1e9;
        if (an!==bn) return an-bn;
        return (a.title||"").localeCompare(b.title||"");
      });

      state.tracks = tracks;

      buildDerivedIndexes();
      renderSidebarPlaylists();
      renderHome();
      renderLibrary();

      if (!state.queue.length){
        state.queue = [...state.tracks];
        state.queueIndex = -1;
        renderQueue();
      }

      syncNowPlayingUI();

      if (getRouteFromHash() === "search"){
        renderChips();
        renderRecentSearches();
        renderSearchView(els.searchInput.value, CATEGORY_CHIPS.find(c=>c.label===state.activeChip)?.q || "");
      }

      toast(`Loaded ${state.tracks.length} tracks.`);
    }

    // ===== INIT =====
    async function init(){
      loadLikes();
      loadModes();

      await initAuth();
// default artwork + img error fallback
      [els.nowArt, els.miniArt, els.npArt, els.albumArt, els.artistArt].forEach(img=>{
        if (!img) return;
        if (!img.getAttribute("src")) img.setAttribute("src", FALLBACK_ART);
        bindImgFallback(img);
      });


      const r = getRouteFromHash();
      routeTo(r);

      renderChips();
      renderRecentSearches();

      wireNav();
      wireSearch();
      wireLibraryTabs();
      wirePlayer();
      wireClicks();
      wireRefresh();
      wireUploadModal();

      try { await loadTracks(); }
      catch (err){ console.error(err); toast(err.message); }

      els.npVol.value = String(els.audio.volume);
      els.npVolHint.textContent = Math.round(els.audio.volume*100) + "%";

      window.addEventListener("resize", ()=>{
        if (!isMobile() && state.sheetOpen) closeSheet();
      });

      // sheet open/close
      els.sheetBackdrop.addEventListener("click", closeSheet);
      els.sheetCloseBtn.addEventListener("click", closeSheet);

      // open sheet from mini
      els.miniPlayer.addEventListener("click", ()=>{
        if (!isMobile()) return;
        openSheet();
        setSheetTab("Now");
      });

      // drag close
      els.sheet.addEventListener("touchstart", (e)=>{
        if (!state.sheetOpen) return;
        sheetDragStart(e.touches[0].clientY);
      }, {passive:true});
      els.sheet.addEventListener("touchmove", (e)=>{
        if (!state.sheetDrag.active) return;
        sheetDragMove(e.touches[0].clientY);
      }, {passive:true});
      els.sheet.addEventListener("touchend", sheetDragEnd, {passive:true});
    }

    init();
  </script>
</body>
</html>
